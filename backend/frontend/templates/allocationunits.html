<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tutor Allocation – Units</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            background: #fff;
        }

        .table-wrap {
            max-width: 900px;
            margin: 2rem auto;
        }

        a.unitlink {
            text-decoration: none;
            color: inherit;
        }

        a.unitlink:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="my-4 h4 fw-semibold">Tutor Allocation – Units</h1>

        <div class="d-flex justify-content-between align-items-center mb-2">
            <div id="aliasTag" class="text-muted small"></div>
            <a id="backBtn" href="/home/" class="btn btn-outline-secondary">← Back to Home</a>
        </div>

        <div class="table-responsive table-wrap">
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width:120px">Unit Code</th>
                        <th>Unit Name</th>
                        <th style="width:100px">Campus</th>
                        <th style="width:140px" class="text-end"># Sessions</th>
                        <th style="width:220px">Allocated Tutors</th>
                    </tr>
                </thead>
                <tbody id="unitsBody">
                    <tr>
                        <td colspan="5" class="text-center text-muted">Loading…</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div id="recordCount" class="small text-muted"></div>
    </div>

    <script>
        // --- auth helpers ---
        const API_BASE = "/api";
        const token = () => localStorage.getItem("access");
        const authHeaders = (extra = {}) => token() ? ({ ...extra, Authorization: `Bearer ${token()}` }) : extra;

        async function apiGet(path) {
            const res = await fetch(`${API_BASE}${path}`, { headers: authHeaders(), credentials: "include" });
            const raw = await res.text();
            let data = null; if (raw) { try { data = JSON.parse(raw); } catch { } }
            if (res.status === 401) { location.href = "/"; throw new Error("Unauthorized"); }
            if (!res.ok) throw new Error((data && (data.detail || data.message)) || raw || `GET ${path} -> ${res.status}`);
            return data ?? raw;
        }

        // Resolve alias from URL (?alias=) or from /semesters/current/
        async function resolveAlias() {
            const qs = new URLSearchParams(location.search);
            const fromUrl = qs.get("alias");
            if (fromUrl) return fromUrl;
            const cur = await apiGet("/semesters/current/");
            return cur.alias;
        }

        async function loadUnits() {
            if (!token()) { location.href = "/"; return; }

            const alias = await resolveAlias();
            document.getElementById("aliasTag").textContent = `Semester: ${alias}`;
            document.getElementById("backBtn").href = `/home/?alias=${encodeURIComponent(alias)}`;

            // IMPORTANT: include trailing slash on DRF endpoints
            const rows = await apiGet(`/allocation/units/?alias=${encodeURIComponent(alias)}`);

            const tbody = document.getElementById("unitsBody");
            if (!Array.isArray(rows) || rows.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">No units found.</td></tr>`;
                document.getElementById("recordCount").textContent = "0 units";
                return;
            }

            tbody.innerHTML = rows.map(u => {
                const detailUrl = `/allocationdetails/?alias=${encodeURIComponent(alias)}&code=${encodeURIComponent(u.unit_code)}&campus=${encodeURIComponent(u.campus)}&name=${encodeURIComponent(u.unit_name || "")}`;

                const tutors = Array.isArray(u.tutors) ? u.tutors : [];
                const tutorHtml = tutors.length
                    ? tutors.map(t => {
                        // pretty URL for timetable page (you have a TemplateView at /tutors/timetable/)
                        const ttUrl = `/tutors/timetable/?alias=${encodeURIComponent(alias)}&name=${encodeURIComponent(t.name)}${t.email ? `&email=${encodeURIComponent(t.email)}` : ""}`;
                        return `<a class="unitlink" href="${ttUrl}">${t.name}</a>`;
                    }).join(", ")
                    : `<span class="text-muted">—</span>`;

                return `
          <tr>
            <td><a class="unitlink" href="${detailUrl}">${u.unit_code}</a></td>
            <td><a class="unitlink" href="${detailUrl}">${u.unit_name || ""}</a></td>
            <td>${u.campus}</td>
            <td class="text-end">${u.session_count}</td>
            <td>${tutorHtml}</td>
          </tr>`;
            }).join("");

            document.getElementById("recordCount").textContent = `${rows.length} units found`;
        }

        document.addEventListener("DOMContentLoaded", () => {
            loadUnits().catch(err => {
                console.error(err);
                alert(`Failed to load units.\n${err.message || err}`);
                document.getElementById("unitsBody").innerHTML =
                    `<tr><td colspan="5" class="text-danger text-center">${(err && err.message) || "Error"}</td></tr>`;
            });
        });
    </script>
</body>

</html>