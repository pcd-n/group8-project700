<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tutor Allocation – Units</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            background: #fff;
        }

        .table-wrap {
            max-width: 900px;
            margin: 2rem auto;
        }

        .section-title {
            font-weight: 600;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        a.unitlink {
            text-decoration: none;
            color: inherit;
        }

        a.unitlink:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1 class="my-4 h4 fw-semibold">Tutor Allocation – Units</h1>
        <div id="aliasTag" class="mb-3 text-muted small"></div>

        <div class="table-responsive table-wrap">
            <table class="table table-bordered align-middle">
                <thead class="table-light">
                    <tr>
                        <th style="width: 120px">Code</th>
                        <th>Name</th>
                        <th style="width: 100px">Campus</th>
                        <th style="width: 140px" class="text-end"># Sessions</th>
                    </tr>
                </thead>
                <tbody id="unitsBody"></tbody>
            </table>
        </div>
        <div id="recordCount" class="small text-muted"></div>
    </div>

    <script>
        const API = { base: "/api" };
        const params = new URLSearchParams(location.search);
        const alias = params.get("alias");

        async function apiGet(path) {
            const res = await fetch(API.base + path, { credentials: "include" });
            if (!res.ok) throw new Error(`GET ${path} failed (${res.status})`);
            return res.json();
        }

        async function loadUnits() {
            try {
                document.getElementById("aliasTag").textContent = alias ? `Semester: ${alias}` : "";
                const units = await apiGet(`/allocation/units/?alias=${encodeURIComponent(alias)}`);
                const tbody = document.getElementById("unitsBody");
                if (!Array.isArray(units) || !units.length) {
                    tbody.innerHTML = `<tr><td colspan="4" class="text-center text-muted">No units found.</td></tr>`;
                    document.getElementById("recordCount").textContent = "0 units";
                    return;
                }
                tbody.innerHTML = units.map(u => {
                    const url = `allocationdetails.html?alias=${encodeURIComponent(alias)}&code=${encodeURIComponent(u.unit_code)}&campus=${encodeURIComponent(u.campus || "")}`;
                    return `<tr>
            <td><a class="unitlink" href="${url}">${u.unit_code}</a></td>
            <td><a class="unitlink" href="${url}">${u.unit_name}</a></td>
            <td>${u.campus || ""}</td>
            <td class="text-end">${u.session_count}</td>
          </tr>`;
                }).join("");
                document.getElementById("recordCount").textContent = `${units.length} units found`;
            } catch (e) {
                console.error(e);
                alert("Failed to load units.");
            }
        }

        document.addEventListener("DOMContentLoaded", loadUnits);
    </script>
</body>

</html>