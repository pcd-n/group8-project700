<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tutor Timetable</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        .grid {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed
        }

        .grid th,
        .grid td {
            border: 1px solid #e5e7eb;
            text-align: center;
            padding: 8px
        }

        .grid thead th {
            background: #f1f5f9
        }

        .timecol {
            width: 80px;
            background: #f8fafc;
            font-weight: 600
        }

        .slot {
            height: 60px;
            vertical-align: top;
            position: relative
        }

        .event {
            position: absolute;
            left: 6px;
            right: 6px;
            border-radius: 4px;
            padding: 4px 6px;
            background: #86efac
        }

        .title {
            font-weight: 600
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 id="ttTitle" class="h5 m-0">Timetable: —</h1>
            <a id="backLink" href="allocationunits.html" class="btn btn-outline-secondary">← Back</a>
        </div>
        <div id="gridWrap" class="table-responsive"></div>
        <div id="empty" class="alert alert-warning d-none mt-3">No assigned classes for this tutor.</div>
    </div>

    <script>
        const API_BASE = "/api";
        const qs = new URLSearchParams(location.search);
        const alias = qs.get("alias") || "";
        const tutorName = decodeURIComponent(qs.get("name") || "");
        const tutorEmail = decodeURIComponent(qs.get("email") || "");

        document.getElementById("ttTitle").textContent = tutorName ? `Timetable: ${tutorName}` : "Timetable";
        document.getElementById("backLink").href = `allocationunits.html?alias=${encodeURIComponent(alias)}`;

        const token = () => localStorage.getItem("access");
        const authHeaders = (extra = {}) => token() ? ({ ...extra, Authorization: `Bearer ${token()}` }) : extra;
        async function apiGet(path) {
            const res = await fetch(`${API_BASE}${path}`, { headers: authHeaders(), credentials: "include" });
            let data = null; try { data = await res.json(); } catch { }
            if (res.status === 401) { location.href = "/"; throw new Error("Unauthorized"); }
            if (!res.ok) throw new Error(data?.detail || `GET ${path} -> ${res.status}`);
            return data;
        }

        document.addEventListener("DOMContentLoaded", async () => {
            try {
                const all = await apiGet(`/timetable/sessions/?alias=${encodeURIComponent(alias)}`);
                const mine = all.filter(s => {
                    if (tutorEmail) return (s.tutor_email || "").toLowerCase() === tutorEmail.toLowerCase();
                    return (s.tutor || "").toLowerCase() === (tutorName || "").toLowerCase();
                });

                if (!mine.length) {
                    document.getElementById("empty").classList.remove("d-none");
                    return;
                }

                renderWeekGrid(mine);
            } catch (e) {
                alert(e.message || e);
            }
        });

        const DAYS = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
        const HSTART = 8, HEND = 20; // 8:00 → 20:00

        function renderWeekGrid(rows) {
            // bucket by day -> by hour
            const byDay = new Map(DAYS.map(d => [d, []]));
            rows.forEach(r => byDay.get(r.day_of_week || "")?.push(r));

            let html = `<table class="grid"><thead><tr><th class="timecol">Time</th>`;
            DAYS.forEach(d => html += `<th>${d}</th>`);
            html += `</tr></thead><tbody>`;

            for (let h = HSTART; h <= HEND; h++) {
                html += `<tr><th class="timecol">${h}:00</th>`;
                for (const day of DAYS) {
                    const matches = (byDay.get(day) || []).filter(s => {
                        const st = (s.start_time || "").split(":").map(Number);
                        return st[0] === h; // place the block on its starting hour
                    });
                    html += `<td class="slot">`;
                    matches.forEach(s => {
                        const label = [
                            (s.activity_code || "").toUpperCase(),
                            s.location ? ` ${s.location}` : "",
                            s.weeks ? ` ${s.weeks}` : ""
                        ].join("");
                        html += `<div class="event" title="${label}">${(s.activity_code || "").toUpperCase()}${s.location ? `<br/>${s.location}` : ""}${s.weeks ? `<br/>${s.weeks}` : ""}</div>`;
                    });
                    html += `</td>`;
                }
                html += `</tr>`;
            }

            html += `</tbody></table>`;
            document.getElementById("gridWrap").innerHTML = html;
        }
    </script>
</body>

</html>