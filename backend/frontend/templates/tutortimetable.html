<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tutor Timetable</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        .grid {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed
        }

        .grid th,
        .grid td {
            border: 1px solid #e5e7eb;
            text-align: center;
            padding: 8px
        }

        .grid thead th {
            background: #f1f5f9
        }

        .timecol {
            width: 80px;
            background: #f8fafc;
            font-weight: 600
        }

        .slot {
            height: 60px;
            vertical-align: top;
            position: relative
        }

        .event {
            position: absolute;
            left: 6px;
            right: 6px;
            border-radius: 4px;
            padding: 4px 6px;
            background: #86efac
        }

        .title {
            font-weight: 600
        }
    </style>
</head>

<body>
    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1 id="ttTitle" class="h5 m-0">Timetable</h1>
            <a id="backLink" href="/home/" class="btn btn-outline-secondary">‚Üê Back</a>
        </div>
        <div id="gridWrap" class="table-responsive"></div>
        <div id="empty" class="alert alert-warning d-none mt-3">No assigned classes for this tutor.</div>
    </div>

    <script>
        const API_BASE = "/api";
        const token = () => localStorage.getItem("access");
        const authHeaders = (extra = {}) => token() ? ({ ...extra, Authorization: `Bearer ${token()}` }) : extra;

        const qs = new URLSearchParams(location.search);
        const alias = qs.get("alias") || "";
        let tutorName = qs.get("name") || "";
        let tutorEmail = (qs.get("email") || "").toLowerCase();

        document.getElementById("ttTitle").textContent = tutorName ? `Timetable: ${tutorName}` : "Timetable";
        document.getElementById("backLink").href = `/allocations/?alias=${encodeURIComponent(alias)}`;

        async function apiGet(path) {
            const res = await fetch(`${API_BASE}${path}`, { headers: authHeaders(), credentials: "include" });
            let data = null; try { data = await res.json(); } catch { }
            if (res.status === 401) { location.href = "/"; throw new Error("Unauthorized"); }
            if (!res.ok) { throw new Error(data?.detail || `GET ${path} -> ${res.status}`); }
            return data || [];
        }

        async function getProfile() {
            return apiGet('/accounts/profile/');
        }

        const backLink = document.getElementById("backLink");
        // If they arrived from allocations, keep that experience for admins/coordinators
        if (document.referrer && document.referrer.includes('/allocations/')) {
            backLink.href = document.referrer;
        } else {
            backLink.href = '/home/';
        }

        async function getCurrentAlias() {
            try {
                const res = await fetch(`${API_BASE}/semesters/current/`, { headers: authHeaders(), credentials: "include" });
                if (!res.ok) throw new Error();
                const { alias } = await res.json();
                return alias || "";
            } catch {
                return "";
            }
        }

        async function resolveTutorIdentity() {
            if (!tutorEmail) {
                const me = await apiGet('/accounts/profile/');
                tutorEmail = (me?.email || '').toLowerCase();
                if (!tutorName) {
                    tutorName = `${me?.first_name || ''} ${me?.last_name || ''}`.trim() || me?.username || '';
                }
                document.getElementById("ttTitle").textContent = tutorName ? `Timetable: ${tutorName}` : "Timetable";

                // If still no email, try to infer from sessions by name (only if unique)
                if (!tutorEmail) {
                    const curr = await apiGet(API.current()).catch(() => ({ alias: alias || '' }));
                    const useAlias = alias || curr.alias || '';
                    if (useAlias) {
                        const all = await apiGet(`/timetable/sessions/?alias=${encodeURIComponent(useAlias)}`);
                        const emails = new Set(
                            all
                                .filter(s => (s.tutor || '').toLowerCase() === tutorName.toLowerCase())
                                .map(s => (s.tutor_email || '').toLowerCase())
                                .filter(Boolean)
                        );
                        if (emails.size === 1) {
                            tutorEmail = [...emails][0];
                        }
                    }
                }

                // reflect in URL (no reload)
                const url = new URL(location.href);
                if (tutorName) url.searchParams.set('name', tutorName);
                if (tutorEmail) url.searchParams.set('email', tutorEmail);
                if (alias) url.searchParams.set('alias', alias);
                history.replaceState(null, '', url);
            }
        }

        document.addEventListener("DOMContentLoaded", async () => {
            if (!token()) { location.href = "/"; return; }

            // Determine role and lock down identity for Tutors
            let me = null, roles = [];
            try {
                me = await getProfile();
                roles = Array.isArray(me?.roles) ? me.roles.map(r => r.name) : [];
            } catch { }

            const isAdmin = !!me?.is_staff || roles.includes('Admin');
            const isCoord = roles.includes('Coordinator');
            const isTutor = roles.includes('Tutor') && !isAdmin && !isCoord;

            if (isTutor) {
                // Force to the authenticated identity
                tutorEmail = (me?.user?.email || me?.email || '').toLowerCase();
                tutorName = `${me?.user?.first_name || me?.first_name || ''} ${me?.user?.last_name || me?.last_name || ''}`.trim() || (me?.user?.username || me?.username || '');
                // Reflect in title and URL (without reload)
                document.getElementById("ttTitle").textContent = tutorName ? `Timetable: ${tutorName}` : "Timetable";
                const url = new URL(location.href);
                if (alias) url.searchParams.set('alias', alias);
                if (tutorName) url.searchParams.set('name', tutorName);
                if (tutorEmail) url.searchParams.set('email', tutorEmail);
                history.replaceState(null, '', url);
            }

            let useAlias = alias || await getCurrentAlias();

            try {
                // DRF endpoint requires trailing slash
                const all = await apiGet(`/timetable/sessions/?alias=${encodeURIComponent(useAlias)}`);

                const mine = all.filter(s => {
                    if (tutorEmail) return ((s.tutor_email || '').toLowerCase() === tutorEmail);
                    if (tutorName) return ((s.tutor || '').toLowerCase() === tutorName.toLowerCase());
                    return false;
                });

                if (!mine.length) {
                    document.getElementById("empty").classList.remove("d-none");
                    return;
                }

                renderWeekGrid(mine);
            } catch (e) {
                alert(e.message || e);
            }
        });

        const DAYS = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
        const HSTART = 8, HEND = 20;

        function renderWeekGrid(rows) {
            const byDay = new Map(DAYS.map(d => [d, []]));
            rows.forEach(r => byDay.get(r.day_of_week || "")?.push(r));

            let html = `<table class="grid"><thead><tr><th class="timecol">Time</th>`;
            DAYS.forEach(d => html += `<th>${d}</th>`);
            html += `</tr></thead><tbody>`;

            for (let h = HSTART; h <= HEND; h++) {
                html += `<tr><th class="timecol">${h}:00</th>`;
                for (const day of DAYS) {
                    const matches = (byDay.get(day) || []).filter(s => {
                        const parts = (s.start_time || "").split(":").map(n => parseInt(n, 10));
                        const hour = Number.isFinite(parts[0]) ? parts[0] : -1;
                        return hour === h; // place on starting hour only
                    });
                    html += `<td class="slot">`;
                    matches.forEach(s => {
                        const code = (s.activity_code || "").toUpperCase();
                        const label = `${code}${s.location ? ` ${s.location}` : ""}${s.weeks ? ` ${s.weeks}` : ""}`;
                        html += `<div class="event" title="${label}">${code}${s.location ? `<br/>${s.location}` : ""}${s.weeks ? `<br/>${s.weeks}` : ""}</div>`;
                    });
                    html += `</td>`;
                }
                html += `</tr>`;
            }

            html += `</tbody></table>`;
            document.getElementById("gridWrap").innerHTML = html;
        }
    </script>
</body>

</html>