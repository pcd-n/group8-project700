<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Users Management</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        body {
            background: #fff;
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        .hidden {
            display: none !important;
        }

        .container-narrow {
            max-width: 1100px;
        }
    </style>
</head>

<body>
    <div class="container container-narrow py-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h2 class="m-0">Users Management</h2>
            <div class="d-flex gap-2">
                <a class="btn btn-outline-secondary" href="/home">← Home</a>
                <button id="btnRefresh" class="btn btn-outline-secondary">Refresh</button>
            </div>
        </div>

        <div id="alerts"></div>

        <!-- Create -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Create New User</h5>
                <form id="formCreate" class="row g-3">
                    <div class="col-md-6">
                        <label for="cuUsername" class="form-label">Username</label>
                        <input id="cuUsername" type="text" class="form-control" autocomplete="off" />
                    </div>
                    <div class="col-md-6">
                        <label for="cuPassword" class="form-label">Password</label>
                        <input id="cuPassword" type="password" class="form-control" autocomplete="new-password" />
                    </div>

                    <div class="col-md-6">
                        <label for="cuRole" class="form-label">Role</label>
                        <select id="cuRole" class="form-select">
                            <!-- populated by renderCreateRoleOptions -->
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label for="cuEmail" class="form-label">Email</label>
                        <input id="cuEmail" type="email" class="form-control" placeholder="email@example.com" />
                        <!-- Tutor email dropdown (only when Role=Tutor) -->
                        <select id="cuEmailSelect" class="form-select mt-2 d-none"></select>
                        <div id="cuEmailHelp" class="form-text d-none">Picked from current semester (EOI upload)</div>
                    </div>

                    <div class="col-md-6">
                        <label for="cuFirst" class="form-label">First name</label>
                        <input id="cuFirst" type="text" class="form-control" />
                    </div>
                    <div class="col-md-6">
                        <label for="cuLast" class="form-label">Last name</label>
                        <input id="cuLast" type="text" class="form-control" />
                    </div>

                    <div class="col-12">
                        <label for="cuNote" class="form-label">Note</label>
                        <textarea id="cuNote" class="form-control" rows="2"></textarea>
                    </div>

                    <div class="col-12">
                        <button class="btn btn-dark" type="submit">Create User</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Existing users -->
        <div id="groupsContainer" class="card">
            <div class="card-body">
                <h5 class="card-title">Existing Users</h5>
                <div class="table-responsive">
                    <table class="table table-sm align-middle">
                        <thead>
                            <tr>
                                <th class="w-25">Username / Email</th>
                                <th class="w-25">Name</th>
                                <th class="w-25">Role</th>
                                <th class="w-25">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="rows"></tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ========= Utilities =========
        function token() {
            try { return localStorage.getItem('access_token'); } catch { return null; }
        }
        const authHeaders = (extra = {}) => token()
            ? ({ ...extra, Authorization: `Bearer ${token()}`, 'Content-Type': 'application/json' })
            : ({ ...extra, 'Content-Type': 'application/json' });

        async function safeJson(res) {
            try { return await res.json(); } catch { return null; }
        }

        function pickApiError(obj, fallback = 'Request failed') {
            if (!obj) return fallback;
            if (typeof obj === 'string') return obj;
            if (obj.detail) return obj.detail;
            if (obj.error) return obj.error;
            if (obj.message) return obj.message;
            try { return JSON.stringify(obj); } catch { return fallback; }
        }

        async function requestJSON(method, url, body) {
            const init = { method, headers: authHeaders() };
            if (body !== undefined) init.body = JSON.stringify(body);
            const res = await fetch(url, init);
            if (!res.ok) {
                const err = await safeJson(res);
                throw new Error(pickApiError(err, `${method} ${url} failed`));
            }
            if (res.status === 204) return true;
            return await safeJson(res);
        }
        const getJSON = (url) => requestJSON('GET', url);
        const postJSON = (url, body) => requestJSON('POST', url, body);
        const putJSON = (url, body) => requestJSON('PUT', url, body);
        const delJSON = (url) => requestJSON('DELETE', url);

        function escapeHtml(s) {
            return (s ?? '').toString()
                .replace(/&/g, '&amp;').replace(/</g, '&lt;')
                .replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
        }
        function showAlert(msg, type = 'danger') {
            const el = document.createElement('div');
            el.className = `alert alert-${type} alert-dismissible fade show`;
            el.role = 'alert';
            el.innerHTML = `${escapeHtml(msg)}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.getElementById('alerts').appendChild(el);
            setTimeout(() => el.remove(), 5000);
        }
        function asArrayMaybePaginated(x) {
            if (!x) return [];
            if (Array.isArray(x)) return x;
            if (x.results && Array.isArray(x.results)) return x.results;
            return [];
        }

        // ========= Alias helpers =========
        async function getCurrentAlias() {
            // 1) ?alias=
            const qs = new URLSearchParams(location.search);
            const fromUrl = qs.get('alias');
            if (fromUrl) return fromUrl;
            // 2) server
            try {
                const r = await getJSON('/api/semesters/current/');
                if (r?.alias) return r.alias;
            } catch { }
            // 3) sessionStorage (Home sets this after uploads)
            const cached = sessionStorage.getItem('eoiPreviewAlias');
            return cached || '';
        }

        // ========= API endpoints =========
        const API = {
            profile: '/api/accounts/profile/',
            roles: '/api/accounts/roles/',
            userRoles: '/api/accounts/user-roles/',
            register: '/api/accounts/register/',
            resetPassword: (userId) => `/api/accounts/users/${userId}/reset-password/`,
            updateNote: (userId) => `/api/accounts/users/${userId}/note/`,
            assignRole: (userId) => `/api/accounts/user-roles/${userId}/`,
            deleteUser: (userId, alias) => `/api/accounts/users/${userId}/?alias=${encodeURIComponent(alias)}`,
            eoiEmails: (alias) => `/api/accounts/tutors/eoi-emails/?alias=${encodeURIComponent(alias)}`,
        };

        // ========= State =========
        let roles = [];
        let users = [];
        let cachedEOITutors = null;   // [{email, first_name, last_name}]
        let cachedAlias = null;
        window.__me = null;

        // ========= Role helpers =========
        function allowedRoles(list) { return list; } // keep as-is (no feature removal)

        // ========= UI refs =========
        const roleSelect = document.getElementById('cuRole');
        const emailInput = document.getElementById('cuEmail');
        const emailSelect = document.getElementById('cuEmailSelect');
        const emailHelp = document.getElementById('cuEmailHelp');
        const firstInput = document.getElementById('cuFirst');
        const lastInput = document.getElementById('cuLast');
        const rowsTbody = document.getElementById('rows');

        // ========= Tutor email dropdown logic =========
        async function fetchEOITutorEmails(alias) {
            const url = API.eoiEmails(alias);
            try {
                return await getJSON(url);
            } catch (e) {
                console.warn('EOI emails list not available:', e);
                return [];
            }
        }
        function showTutorEmailSelect(show) {
            if (show) {
                emailInput.classList.add('d-none');
                emailInput.required = false; // avoid hidden+required oddities
                emailSelect.classList.remove('d-none');
                emailHelp.classList.remove('d-none');
            } else {
                emailInput.classList.remove('d-none');
                emailSelect.classList.add('d-none');
                emailHelp.classList.add('d-none');
            }
        }
        function populateEmailSelect(list) {
            emailSelect.innerHTML = '';
            const opt0 = document.createElement('option');
            opt0.value = '';
            opt0.textContent = '— Select a tutor email —';
            emailSelect.appendChild(opt0);
            list.forEach(t => {
                const o = document.createElement('option');
                const fn = (t.first_name || '').trim();
                const ln = (t.last_name || '').trim();
                o.value = String(t.email || '').toLowerCase();
                o.textContent = fn || ln ? `${o.value} (${fn} ${ln})` : o.value;
                emailSelect.appendChild(o);
            });
        }
        async function syncEmailControlForRole() {
            const isTutor = roleSelect.value === 'Tutor';
            if (!isTutor) {
                showTutorEmailSelect(false);
                emailInput.required = false; // optional, we also validate on submit
                return;
            }
            emailInput.required = false; // we enforce via JS guard instead
            showTutorEmailSelect(true);
            const alias = cachedAlias || (cachedAlias = await getCurrentAlias());
            if (!cachedEOITutors) {
                cachedEOITutors = await fetchEOITutorEmails(alias);
            }
            if (cachedEOITutors && cachedEOITutors.length) {
                populateEmailSelect(cachedEOITutors);
            } else {
                // fallback to manual input if list unavailable/empty
                showTutorEmailSelect(false);
            }
        }
        emailSelect.addEventListener('change', () => {
            const val = (emailSelect.value || '').toLowerCase();
            emailInput.value = val; // submit handler reads from input
            const t = (cachedEOITutors || []).find(x => x.email === val);
            if (t) {
                firstInput.value = t.first_name || '';
                lastInput.value = t.last_name || '';
            }
            document.getElementById('cuUsername').focus();
        });
        roleSelect.addEventListener('change', syncEmailControlForRole);

        // ========= Renderers =========
        function renderCreateRoleOptions() {
            const list = allowedRoles(asArrayMaybePaginated(roles));
            roleSelect.innerHTML = list.map(r => `<option value="${escapeHtml(r.role_name)}">${escapeHtml(r.role_name)}</option>`).join('');
            // default to Tutor to encourage using the dropdown when needed
            if (list.some(x => x.role_name === 'Tutor')) roleSelect.value = 'Tutor';
        }

        function renderRow(r) {
            // self-protection: don't allow removing yourself
            const isMe = !!(window.__me && window.__me.id === r.user);
            const canRemove = !isMe;

            const uname = r.user_username || r.user_email || '';
            const display = r.user_name || '—';
            const preview = (r.user_note || '').trim();
            const previewShort = preview ? (preview.length > 40 ? preview.slice(0, 40) + '…' : preview) : '—';

            const list = allowedRoles(asArrayMaybePaginated(roles));
            const roleOpts = list.map(opt => {
                const sel = opt.role_name === r.role_name ? 'selected' : '';
                return `<option value="${opt.role_name}" ${sel}>${opt.role_name}</option>`;
            }).join('');

            const removeBtn = canRemove
                ? `<button class="btn btn-sm btn-outline-danger"
                     data-action="remove"
                     data-user="${r.user}"
                     title="Remove platform account. If Tutor, clears alias username.">
               Remove
           </button>`
                : `<button class="btn btn-sm btn-outline-danger" disabled
                   title="You cannot remove your own account.">Remove</button>`;

            return `
        <tr>
          <td class="mono">${escapeHtml(uname)}</td>
          <td>${escapeHtml(display)}</td>
          <td>
            <select class="form-select form-select-sm"
                    data-action="change-role"
                    data-user="${r.user}">
              ${roleOpts}
            </select>
          </td>
          <td class="d-flex flex-column gap-2">
            <div class="small text-muted">Note: ${escapeHtml(previewShort)}</div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary"
                      data-action="edit-note"
                      data-user="${r.user}">
                Edit note
              </button>
              <button class="btn btn-sm btn-outline-secondary"
                      data-action="reset"
                      data-user="${r.user}">
                Reset password
              </button>
              ${removeBtn}
            </div>
          </td>
        </tr>`;
        }

        function renderUsers() {
            const list = asArrayMaybePaginated(users);
            rowsTbody.innerHTML = list.map(renderRow).join('');
        }

        // ========= Loaders =========
        async function loadAll() {
            const [rRoles, rUsers] = await Promise.all([
                getJSON(API.roles),
                getJSON(API.userRoles)
            ]);
            roles = rRoles;
            users = rUsers;
            renderUsers();
        }

        // ========= Actions =========
        document.getElementById('formCreate').addEventListener('submit', async (e) => {
            e.preventDefault();
            const role = roleSelect.value;
            let email = (emailInput.value || '').trim().toLowerCase();

            // Tutor requires an email (selected from dropdown or typed)
            if (role === 'Tutor' && !email) {
                showAlert('Email is required for Tutor accounts.', 'warning');
                return;
            }

            const body = {
                username: document.getElementById('cuUsername').value.trim(),
                password: document.getElementById('cuPassword').value,
                role_name: role,
                email: email || null,
                first_name: document.getElementById('cuFirst').value.trim(),
                last_name: document.getElementById('cuLast').value.trim(),
                note: document.getElementById('cuNote').value.trim() || null,
                is_supervisor: false,
                campus_id: null
            };

            try {
                await postJSON(API.register, body);
                e.target.reset();
                renderCreateRoleOptions();
                await syncEmailControlForRole(); // prepare Tutor dropdown again
                showAlert('User created', 'success');
                await loadAll();
            } catch (err) {
                showAlert(err.message || 'Create failed');
                console.warn('Create user error:', err);
            }
        });

        // Delegated actions for table (role change, edit note, reset, remove)
        document.getElementById('groupsContainer').addEventListener('click', async (e) => {
            const btn = e.target.closest('button[data-action]');
            if (!btn) return;
            const action = btn.dataset.action;
            const userId = Number(btn.getAttribute('data-user'));
            if (!userId) return;

            // Reset password
            if (action === 'reset') {
                if (!confirm('Reset password for this user?')) return;
                try {
                    await postJSON(API.resetPassword(userId), {});
                    showAlert('Password reset email sent (if configured).', 'success');
                } catch (err) {
                    showAlert(err.message || 'Reset password failed');
                }
                return;
            }

            // Edit note
            if (action === 'edit-note') {
                const row = btn.closest('tr');
                const current = (row?.querySelector('.small.text-muted')?.textContent || '').replace(/^Note:\s*/, '').trim();
                const newNote = prompt('Update note:', current === '—' ? '' : current);
                if (newNote === null) return;
                try {
                    await putJSON(API.updateNote(userId), { note: newNote });
                    showAlert('Note updated', 'success');
                    await loadAll();
                } catch (err) {
                    showAlert(err.message || 'Update note failed');
                }
                return;
            }

            // Remove (DELETE + clear alias username if Tutor on backend)
            if (action === 'remove') {
                const alias = await getCurrentAlias();
                const row = btn.closest('tr');
                const uname = row?.querySelector('td')?.textContent?.trim() || '';
                if (!confirm(`Remove user ${uname}? This will delete the platform account.\nIf the user is a Tutor, their alias username will be cleared.`)) return;
                try {
                    await delJSON(API.deleteUser(userId, alias));
                    showAlert('User removed', 'success');
                    await loadAll();
                    // refresh Tutor dropdown caches (in case a removed tutor frees a username etc.)
                    cachedAlias = null;
                    cachedEOITutors = null;
                    await syncEmailControlForRole();
                } catch (err) {
                    showAlert(err.message || 'Remove failed');
                    console.warn('Remove user error:', err);
                }
                return;
            }
        });

        // Change role (via <select>)
        document.getElementById('groupsContainer').addEventListener('change', async (e) => {
            const sel = e.target.closest('select[data-action="change-role"]');
            if (!sel) return;
            const newRole = sel.value;
            const userId = Number(sel.dataset.user);
            try {
                await postJSON(API.assignRole(userId), { role_name: newRole });
                showAlert('Role updated', 'success');
                await loadAll();
            } catch (err) {
                showAlert(err.message || 'Role update failed');
            }
        });

        // Refresh button
        document.getElementById('btnRefresh').addEventListener('click', async () => {
            cachedAlias = null;
            cachedEOITutors = null;
            await loadAll();
            await syncEmailControlForRole();
        });

        // ========= Init =========
        async function init() {
            if (!token()) {
                location.href = '/';
                return;
            }

            // Admin gate
            let me = null;
            try { me = await getJSON(API.profile); } catch { }
            const rs = Array.isArray(me?.roles) ? me.roles.map(r => r.name || r.role_name) : [];
            const isAdmin = !!me?.user?.is_staff || rs.includes('Admin');
            if (!isAdmin) {
                showAlert('Admins only.', 'warning');
                return;
            }
            window.__me = me?.user || null;

            // Load data
            await loadAll();

            // Prepare create form role options + Tutor dropdown (if Tutor selected)
            renderCreateRoleOptions();
            await syncEmailControlForRole();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>