<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Users Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        .card-role {
            border-radius: 16px;
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
        }
    </style>
</head>

<body class="bg-light">
    <div class="container py-4">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <h1 class="h4 m-0">Users Management</h1>
            <div class="d-flex gap-2">
                <a href="/home/" class="btn btn-outline-secondary">← Home</a>
                <button id="btnRefresh" class="btn btn-outline-dark">Refresh</button>
            </div>
        </div>

        <div id="alertBox" class="alert d-none" role="alert"></div>

        <!-- Create user -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Create New User</h5>
                <form id="formCreate" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Username</label>
                        <input id="cuUsername" class="form-control" required />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Password</label>
                        <input id="cuPassword" type="password" minlength="8" class="form-control" required />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Role</label>
                        <select id="cuRole" class="form-select"></select>
                    </div>

                    <div class="mb-3">
                        <label for="cuEmail" class="form-label">Email</label>
                        <input id="cuEmail" type="email" class="form-control" placeholder="email@example.com">
                        <!-- Tutor email dropdown (shown only when Role = Tutor) -->
                        <select id="cuEmailSelect" class="form-select mt-2 d-none"></select>
                        <div id="cuEmailHelp" class="form-text d-none">Picked from current semester (EOI upload)</div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label">First name</label>
                        <input id="cuFirst" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Last name</label>
                        <input id="cuLast" class="form-control" />
                    </div>

                    <div class="col-12">
                        <label class="form-label">Note</label>
                        <textarea id="cuNote" class="form-control" rows="2"></textarea>
                    </div>
                    <div class="col-12">
                        <button class="btn btn-dark">Create User</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Users grouped by role -->
        <div id="groupsContainer" class="vstack gap-3"></div>
    </div>

    <script>
        // ---------- API endpoints (unchanged from your working page) ----------
        const API = {
            roles: '/api/accounts/roles/',
            listUserRoles: '/api/accounts/user-roles/',
            assignRole: (userId) => `/api/accounts/user-roles/${userId}/`,
            register: '/api/accounts/register/',
            resetPassword: '/api/accounts/users/reset-password/',      // expects {user_id,new_password}
            updateUser: (id) => `/api/accounts/users/update/${id}/`,   // PUT note / is_active
            profile: '/api/accounts/profile/'
        };

        // ---------- Auth helpers (match old storage; add safe fallback) ----------
        const token = () =>
            localStorage.getItem('access') ||
            localStorage.getItem('access_token') || // fallback if some pages stored a different key
            null;

        const authHeaders = (extra = {}) => token()
            ? ({ ...extra, Authorization: `Bearer ${token()}`, 'Content-Type': 'application/json' })
            : ({ ...extra, 'Content-Type': 'application/json' });

        // ---------- Alerts ----------
        function showAlert(msg, type = 'danger') {
            const box = document.getElementById('alertBox');
            box.className = `alert alert-${type}`;
            box.textContent = msg;
            box.classList.remove('d-none');
            setTimeout(() => box.classList.add('d-none'), 5000);
        }

        // ---------- Error helpers ----------
        function pickApiError(payload, fallback = 'Request failed') {
            if (!payload) return fallback;
            if (typeof payload === 'string') return payload;
            if (payload.detail) return String(payload.detail);
            if (payload.error) return String(payload.error);
            if (Array.isArray(payload)) return payload.join(' | ') || fallback;
            if (typeof payload === 'object') {
                const parts = [];
                for (const [k, v] of Object.entries(payload)) {
                    const msg = Array.isArray(v) ? v.join(', ') : (typeof v === 'object' ? JSON.stringify(v) : String(v));
                    parts.push(`${k}: ${msg}`);
                }
                return parts.join(' | ') || fallback;
            }
            return fallback;
        }
        async function safeJson(res) { try { return await res.json(); } catch { return null; } }

        // ---------- Request helpers ----------
        async function requestJSON(method, url, body) {
            const res = await fetch(url, {
                method,
                headers: authHeaders(),
                credentials: 'include',
                body: body === undefined ? undefined : JSON.stringify(body)
            });
            let data = await safeJson(res);
            if (!res.ok) throw new Error(pickApiError(data, `${url} → ${res.status}`));
            return data ?? {};
        }
        const getJSON = (url) => requestJSON('GET', url);
        const postJSON = (url, body) => requestJSON('POST', url, body);
        const putJSON = (url, body) => requestJSON('PUT', url, body);
        async function delJSON(url) {
            const res = await fetch(url, { method: 'DELETE', headers: authHeaders() });
            if (!res.ok && res.status !== 204) {
                const err = await safeJson(res);
                throw new Error(pickApiError(err, 'Delete failed'));
            }
            return true;
        }

        // ---------- Small utils ----------
        function escapeHtml(s) { return String(s ?? '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m])); }
        function asArrayMaybePaginated(x) { if (Array.isArray(x)) return x; if (x && Array.isArray(x.results)) return x.results; return []; }
        function allowedRoles(list) {
            const allow = new Set(['Admin', 'Coordinator', 'Tutor']);
            return (Array.isArray(list) ? list : []).filter(r => allow.has(r.role_name || r.name));
        }

        // ---------- State ----------
        let roles = [];
        let rows = [];
        let cachedEOITutors = null;   // [{email, first_name, last_name}]
        let cachedAlias = null;
        window.__me = null;

        // ---------- Alias helpers (match other pages) ----------
        async function getCurrentAlias() {
            const qs = new URLSearchParams(location.search);
            const fromUrl = qs.get('alias');
            if (fromUrl) return fromUrl;
            try {
                const { alias } = await getJSON('/api/semesters/current/');
                if (alias) return alias;
            } catch (_) { }
            return sessionStorage.getItem('eoiPreviewAlias') || '';
        }

        // ---------- Tutor EOI email picker ----------
        async function fetchEOITutorEmails(alias) {
            // NOTE: mounted under /api/accounts/... on your backend
            const url = `/api/accounts/tutors/eoi-emails/?alias=${encodeURIComponent(alias)}`;
            try { return await getJSON(url); }
            catch (e) { console.warn('EOI emails not available:', e); return []; }
        }

        const roleSelect = document.getElementById('cuRole');
        const emailInput = document.getElementById('cuEmail');
        const emailSelect = document.getElementById('cuEmailSelect');
        const emailHelp = document.getElementById('cuEmailHelp');
        const firstInput = document.getElementById('cuFirst');
        const lastInput = document.getElementById('cuLast');

        function showTutorEmailSelect(show) {
            if (show) {
                emailInput.classList.add('d-none');
                emailInput.required = false; // avoid hidden+required issues
                emailSelect.classList.remove('d-none');
                emailHelp.classList.remove('d-none');
            } else {
                emailInput.classList.remove('d-none');
                emailSelect.classList.add('d-none');
                emailHelp.classList.add('d-none');
            }
        }
        function populateEmailSelect(list) {
            emailSelect.innerHTML = '';
            const opt0 = document.createElement('option');
            opt0.value = '';
            opt0.textContent = '— Select a tutor email —';
            emailSelect.appendChild(opt0);
            list.forEach(t => {
                const o = document.createElement('option');
                const fn = (t.first_name || '').trim();
                const ln = (t.last_name || '').trim();
                o.value = String(t.email || '').toLowerCase();
                o.textContent = fn || ln ? `${o.value} (${fn} ${ln})` : o.value;
                emailSelect.appendChild(o);
            });
        }
        async function syncEmailControlForRole() {
            const isTutor = roleSelect.value === 'Tutor';
            if (!isTutor) { showTutorEmailSelect(false); emailInput.required = false; return; }
            showTutorEmailSelect(true);
            const alias = cachedAlias || (cachedAlias = await getCurrentAlias());
            if (!cachedEOITutors) cachedEOITutors = await fetchEOITutorEmails(alias);
            if (cachedEOITutors?.length) populateEmailSelect(cachedEOITutors);
            else showTutorEmailSelect(false); // fallback to manual input
        }
        emailSelect.addEventListener('change', () => {
            const val = (emailSelect.value || '').toLowerCase();
            emailInput.value = val;
            const t = (cachedEOITutors || []).find(x => x.email === val);
            if (t) { firstInput.value = t.first_name || ''; lastInput.value = t.last_name || ''; }
            document.getElementById('cuUsername').focus();
        });
        roleSelect.addEventListener('change', syncEmailControlForRole);

        // ---------- Render ----------
        function renderCreateRoleOptions() {
            const list = allowedRoles(roles);
            roleSelect.innerHTML = list.map(r => `<option value="${r.role_name}">${r.role_name}</option>`).join('');
            if (list.find(r => r.role_name === 'Tutor')) roleSelect.value = 'Tutor';
        }
        function renderRow(r) {
            const isMe = !!(window.__me && window.__me.id === r.user);
            const canRemove = !isMe;

            const uname = r.user_username || r.user_email || '';
            const display = r.user_name || '—';
            const preview = (r.user_note || '').trim();
            const previewShort = preview ? (preview.length > 40 ? preview.slice(0, 40) + '…' : preview) : '—';

            const list = allowedRoles(asArrayMaybePaginated(roles));
            const roleOpts = list.map(opt => {
                const sel = opt.role_name === r.role_name ? 'selected' : '';
                return `<option value="${opt.role_name}" ${sel}>${opt.role_name}</option>`;
            }).join('');

            const removeBtn = canRemove
                ? `<button class="btn btn-sm btn-outline-danger"
             data-action="remove" data-user="${r.user}"
             title="Remove platform account. If Tutor, clears alias username.">Remove</button>`
                : `<button class="btn btn-sm btn-outline-danger" disabled
             title="You cannot remove your own account.">Remove</button>`;

            return `
        <tr>
          <td class="mono">${escapeHtml(uname)}</td>
          <td>${escapeHtml(display)}</td>
          <td>
            <select class="form-select form-select-sm"
                    data-action="change-role" data-user="${r.user}">
              ${roleOpts}
            </select>
          </td>
          <td class="d-flex flex-column gap-2">
            <div class="small text-muted">Note: ${escapeHtml(previewShort)}</div>
            <div class="d-flex gap-2">
              <button class="btn btn-sm btn-outline-primary"
                      data-action="edit-note" data-user="${r.user}">Edit note</button>
              <button class="btn btn-sm btn-outline-secondary"
                      data-action="reset" data-user="${r.user}">Reset password</button>
              ${removeBtn}
            </div>
          </td>
        </tr>`;
        }
        function renderGroups() {
            const byRole = new Map();
            rows.forEach(r => {
                const k = r.role_name || '(No Role)';
                if (!byRole.has(k)) byRole.set(k, []);
                byRole.get(k).push(r);
            });
            const sorted = Array.from(byRole.entries()).sort((a, b) => a[0].localeCompare(b[0]));
            const container = document.getElementById('groupsContainer');
            container.innerHTML = '';
            sorted.forEach(([roleName, items]) => {
                const card = document.createElement('div');
                card.className = 'card card-role';
                card.innerHTML = `
          <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h5 class="card-title mb-0">${roleName} <span class="text-muted">(${items.length})</span></h5>
            </div>
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead class="table-light">
                  <tr>
                    <th>Username</th><th>Name</th><th style="width:240px">Role</th><th style="width:260px">Actions</th>
                  </tr>
                </thead>
                <tbody>${items.map(renderRow).join('')}</tbody>
              </table>
            </div>
          </div>`;
                container.appendChild(card);
            });
            if (!sorted.length) container.innerHTML = `<div class="alert alert-secondary">No users found.</div>`;
        }

        // ---------- Loaders ----------
        async function loadAll() {
            const [r, u] = await Promise.all([getJSON(API.roles), getJSON(API.listUserRoles)]);
            roles = asArrayMaybePaginated(r);
            rows = asArrayMaybePaginated(u);
            renderCreateRoleOptions();
            renderGroups();
        }

        // ---------- Events ----------
        document.getElementById('btnRefresh').addEventListener('click', async () => {
            cachedAlias = null;
            cachedEOITutors = null;
            await loadAll();
            await syncEmailControlForRole();
        });

        // Old listener kept (does nothing if #tblUsers absent), but we’ll also handle remove below
        document.getElementById('tblUsers')?.addEventListener('click', async (e) => {
            const btn = e.target.closest('button[data-cmd]');
            if (!btn) return;
            if (btn.dataset.cmd === 'remove') {
                const alias = await getCurrentAlias();
                const id = btn.dataset.id;
                try { await delJSON(`/api/accounts/users/${id}/?alias=${encodeURIComponent(alias)}`); showAlert('User removed', 'success'); await loadAll(); }
                catch (err) { showAlert(err.message || 'Remove failed'); }
            }
        });

        document.getElementById('groupsContainer').addEventListener('change', async (e) => {
            const sel = e.target.closest('select[data-action="change-role"]');
            if (!sel) return;
            const userId = sel.getAttribute('data-user');
            const newRole = sel.value;
            try { await postJSON(API.assignRole(userId), { role_name: newRole }); showAlert('Role updated', 'success'); await loadAll(); }
            catch (err) { showAlert(err.message || 'Role update failed'); }
        });

        document.getElementById('groupsContainer').addEventListener('click', async (e) => {
            const btn = e.target.closest('button[data-action]');
            if (!btn) return;
            const userId = Number(btn.getAttribute('data-user'));

            if (btn.dataset.action === 'edit-note') {
                const current = rows.find(x => x.user === userId)?.user_note || '';
                const next = prompt('Edit note for this user:', current || '');
                if (next === null) return;
                try { await putJSON(API.updateUser(userId), { note: next }); showAlert('Note updated', 'success'); await loadAll(); }
                catch (err) { showAlert(err.message || 'Note update failed'); }
            }

            if (btn.dataset.action === 'reset') {
                const pwd = prompt('Enter a new password: (min 8 chars)');
                if (!pwd) return;
                try { await postJSON(API.resetPassword, { user_id: userId, new_password: pwd }); showAlert('Password updated', 'success'); }
                catch (err) { showAlert(err.message || 'Password reset failed'); }
            }

            if (btn.dataset.action === 'remove') {
                const alias = await getCurrentAlias();
                const row = btn.closest('tr');
                const uname = row?.querySelector('td')?.textContent?.trim() || '';
                if (!confirm(`Remove user ${uname}? This will delete the platform account.\nIf the user is a Tutor, their alias username will be cleared.`)) return;
                try {
                    await delJSON(`/api/accounts/users/${userId}/?alias=${encodeURIComponent(alias)}`);
                    showAlert('User removed', 'success');
                    await loadAll();
                    cachedAlias = null; cachedEOITutors = null;
                    await syncEmailControlForRole();
                } catch (err) {
                    showAlert(err.message || 'Remove failed');
                    console.warn('Remove user error:', err);
                }
            }
        });

        // ---------- Create user ----------
        function isValidEmail(s) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s); }
        document.getElementById('formCreate').addEventListener('submit', async (e) => {
            e.preventDefault();
            const role = roleSelect.value;
            let email = (emailInput.value || '').trim();

            if (role === 'Tutor') {
                if (!email) { showAlert('Email is required for Tutor accounts.', 'warning'); return; }
                email = email.toLowerCase();
                if (!isValidEmail(email)) { showAlert('Please enter a valid email for the Tutor.', 'warning'); return; }
            } else {
                email = email ? email.toLowerCase() : null;
            }

            const body = {
                username: document.getElementById('cuUsername').value.trim(),
                password: document.getElementById('cuPassword').value,
                role_name: role,
                email,
                first_name: document.getElementById('cuFirst').value.trim(),
                last_name: document.getElementById('cuLast').value.trim(),
                note: document.getElementById('cuNote').value.trim() || null,
                is_supervisor: false,
                campus_id: null
            };

            try {
                await postJSON(API.register, body);
                e.target.reset();
                showAlert('User created', 'success');
                await loadAll();
                renderCreateRoleOptions();
                await syncEmailControlForRole();
            } catch (err) {
                showAlert(err.message || 'Create failed');
                console.warn('Create user error:', err);
            }
        });

        // ---------- Init (Admin gate fixed) ----------
        (async function init() {
            if (!token()) { location.href = '/'; return; } // same behavior as old page
            try {
                const me = await getJSON(API.profile);
                const rs = Array.isArray(me?.roles)
                    ? me.roles.map(r => r.name || r.role_name)
                    : [];
                const isAdmin = !!(me?.user?.is_staff ?? me?.is_staff) || rs.includes('Admin') || rs.includes('Administrator');
                if (!isAdmin) {
                    document.body.innerHTML = '<div class="container py-5"><div class="alert alert-danger">Forbidden</div></div>';
                    return;
                }
                window.__me = me?.user || me || null;
            } catch {
                document.body.innerHTML = '<div class="container py-5"><div class="alert alert-danger">Unauthorized</div></div>';
                return;
            }
            await loadAll();
            renderCreateRoleOptions();
            await syncEmailControlForRole();
        })();
    </script>
</body>

</html>