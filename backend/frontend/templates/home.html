<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web Based Tutor Allocation System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      background: #fff;
    }

    .hero {
      min-height: 34vh;
      display: grid;
      place-items: center;
      text-align: center;
    }

    .btn-pill {
      border-radius: 999px;
    }

    .btn-wide {
      min-width: 240px;
    }

    .file-note {
      font-size: .9rem;
      color: #6b7280;
    }

    .hidden {
      display: none !important;
    }

    .table-wrap {
      max-width: 1000px;
    }

    .units-table tr {
      cursor: pointer;
    }

    .section-title {
      font-weight: 600;
      letter-spacing: .2px;
    }

    a.rowlink {
      text-decoration: none;
      color: inherit;
    }

    a.rowlink:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <div class="container hero">
    <div>
      <h1 class="h5 fw-semibold mb-4">Web Based Tutor Allocation System</h1>

      <!-- Admin tools -->
      <div id="adminSemesterTools" class="card mb-3 d-none">
        <div class="card-body">
          <h5 class="card-title">Semester Databases</h5>
          <div class="row g-2 align-items-end">
            <div class="col-auto">
              <label class="form-label">Create new</label>
              <div class="input-group">
                <input id="semYear" type="number" class="form-control" placeholder="Year e.g. 2026" />
                <select id="semTerm" class="form-select">
                  <option value="S1">Semester 1</option>
                  <option value="S2">Semester 2</option>
                  <option value="S3">Semester 3</option>
                  <option value="S4">Semester 4</option>
                </select>
                <button id="btnCreateSem" class="btn btn-primary">Create & set current</button>
              </div>
            </div>
            <div class="col-auto">
              <label class="form-label">View semester (read-only)</label>
              <div class="input-group">
                <select id="semView" class="form-select"></select>
                <button id="btnViewApply" class="btn btn-outline-secondary">Apply</button>
                <button id="btnViewReset" class="btn btn-outline-secondary">Current</button>
              </div>
            </div>
          </div>
          <small class="text-muted">Uploads always go to the current semester. Old semesters are view-only.</small>
        </div>
      </div>

      <div class="d-flex flex-column align-items-center gap-2">
        <!-- EOI -->
        <input id="eoiFile" type="file" class="d-none" accept=".xlsx,.xls,.csv" />
        <button id="btnUpload" class="btn btn-dark btn-pill btn-wide" type="button">Upload EOI Spreadsheet</button>
        <div id="eoiInfoRow" class="file-note mt-1"></div>
        <div id="fileName" class="file-note"></div>

        <!-- Master Class List / Allocation -->
        <input id="allocFile" type="file" class="d-none" accept=".xlsx,.xls,.csv" />
        <button id="btnProceedAlloc" class="btn btn-success btn-pill btn-wide mt-2" type="button">
          Proceed to Tutor Allocation
        </button>
        <div id="allocInfoRow" class="file-note mt-1"></div>
        <div id="allocFileName" class="file-note"></div>

        <!-- Admin-only: Users Management -->
        <div class="d-flex justify-content-center mt-3">
          <a id="btnUsersMgmt" href="/admin/users" class="btn btn-outline-dark btn-pill btn-wide d-none">Users
            Management</a>
        </div>
      </div>
    </div>
  </div>

  <!-- EOI units (Code + Name only) -->
  <div id="unitsSection" class="container table-wrap hidden">
    <div class="mb-2">
      <div class="section-title">Computing And Information Systems Units</div>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered align-middle units-table">
        <thead class="table-light">
          <tr>
            <th style="width:160px">Code</th>
            <th>Name</th>
          </tr>
        </thead>
        <tbody id="unitsBody"></tbody>
      </table>
    </div>
    <div id="recordCount" class="small text-muted"></div>
  </div>

  <!-- Tutor Allocations: Code | Name | Staffs -->
  <div id="allocSection" class="container table-wrap hidden">
    <div class="mb-2">
      <div class="section-title">Computing And Information Systems Units For Semester</div>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:160px">Code</th>
            <th>Name</th>
            <th style="width:280px">Staffs</th>
          </tr>
        </thead>
        <tbody id="allocBody"></tbody>
      </table>
    </div>
    <div id="allocCount" class="small text-muted"></div>
  </div>

  <script>
    // ========================= Endpoints =========================
    const API = {
      base: "/api",
      // imports
      importsUpload: "/imports/upload/",                 // FormData: { import_type, file }
      importsStatus: (alias) => `/imports/status/?alias=${encodeURIComponent(alias)}`, // <— NEW
      finalizeEOI: (alias) => `/imports/finalize/?alias=${encodeURIComponent(alias)}`,
      // allocation
      runAllocation: (alias) => `/allocation/run/?alias=${encodeURIComponent(alias)}`,
      // semesters
      semestersList: "/semesters/",
      semestersCreate: "/semesters/create/",
      semestersSelect: "/semesters/select/",
      current: () => `/semesters/current/`,
      upload: () => `/allocation/upload/`,
      finalize: (alias) => `/allocation/finalize/?alias=${encodeURIComponent(alias)}`,
      meCandidates: ["/users/me/", "/me/"],
    };

    // ========================= Auth helpers =========================
    const token = () => localStorage.getItem("access");
    const authHeaders = (extra = {}) => token() ? ({ ...extra, Authorization: `Bearer ${token()}` }) : extra;

    async function apiGet(path) {
      const res = await fetch(`${API.base}${path}`, { headers: authHeaders(), credentials: "include" });
      let data = null; try { data = await res.json(); } catch { }
      if (!res.ok) throw new Error(data?.detail || `GET ${path} failed (${res.status})`);
      return data;
    }
    async function apiPostJSON(path, body) {
      const res = await fetch(`${API.base}${path}`, {
        method: "POST", headers: authHeaders({ "Content-Type": "application/json" }), credentials: "include",
        body: JSON.stringify(body)
      });
      let data = null; try { data = await res.json(); } catch { }
      if (!res.ok) throw new Error(data?.detail || `POST ${path} failed (${res.status})`);
      return data ?? {};
    }
    async function apiPostForm(path, formData) {
      const res = await fetch(`${API.base}${path}`, { method: "POST", headers: authHeaders(), credentials: "include", body: formData });
      let data = null; try { data = await res.json(); } catch { }
      if (!res.ok) throw new Error(data?.detail || `Upload failed (${res.status})`);
      return data ?? {};
    }
    async function getCurrentAlias() {
      try { const { alias } = await apiGet(API.current()); return alias; }
      catch {
        const list = await apiGet(API.semestersList);
        const cur = (list || []).find(s => s.is_current) || (list || [])[0];
        if (!cur) throw new Error("No semesters available");
        return cur.alias;
      }
    }

    // ========================= Admin tools visibility =========================
    const adminCard = document.getElementById("adminSemesterTools");
    async function maybeShowAdminTools() {
      for (const p of (API.meCandidates || [])) {
        try {
          const me = await apiGet(p);
          const isAdmin = !!me?.is_staff || (Array.isArray(me?.roles) && me.roles.includes("Admin")) || me?.role === "Admin";
          if (isAdmin) { adminCard.classList.remove("d-none"); return; }
        } catch { }
      }
      // If we can't determine, show controls; server will enforce perms
      adminCard.classList.remove("d-none");
    }

    // ========================= Semester UI =========================
    const semYearInput = document.getElementById("semYear");
    const semTermSelect = document.getElementById("semTerm");
    const btnCreateSem = document.getElementById("btnCreateSem");
    const semViewSelect = document.getElementById("semView");
    const btnViewApply = document.getElementById("btnViewApply");
    const btnViewReset = document.getElementById("btnViewReset");

    function labelForTerm(term) {
      const t = String(term || "").toUpperCase().trim();
      if (t === "S1" || t.includes("SEMESTER 1")) return "S1";
      if (t === "S2" || t.includes("SEMESTER 2")) return "S2";
      if (t === "S3" || t.includes("SEMESTER 3")) return "S3";
      if (t === "S4" || t.includes("SEMESTER 4")) return "S4";
      if (t.includes("SPRING")) return "SPRING";
      if (t.includes("SUMMER")) return "SUMMER";
      if (t.includes("WINTER")) return "WINTER";
      return term || "TERM";
    }

    async function loadSemesters() {
      try {
        const list = await apiGet(API.semestersList);
        semViewSelect.innerHTML = "";
        (list || []).forEach(s => {
          const opt = document.createElement("option");
          opt.value = s.alias;
          const tag = s.is_current ? " (current)" : "";
          const termLabel = labelForTerm(s.term);
          opt.textContent = `${s.year} ${termLabel}${tag}`;
          semViewSelect.appendChild(opt);
        });
      } catch (e) { console.warn("Failed to load semesters:", e); }
    }

    btnCreateSem?.addEventListener("click", async () => {
      const year = Number(semYearInput.value), term = semTermSelect.value;
      if (!year || year < 2000) return alert("Enter a valid year (e.g., 2026).");
      try {
        const created = await apiPostJSON(API.semestersCreate, { year, term, make_current: true });
        alert(`Created ${created?.year} ${created?.term} and set as current.`);
        ["eoiUnits", "eoiPreviewAlias", "eoiUploadDisabled", "eoiFileName"].forEach(k => sessionStorage.removeItem(k));
        location.reload();
      } catch (e) { alert(e.message || "Failed to create semester."); }
    });
    btnViewApply?.addEventListener("click", async () => {
      const alias = semViewSelect.value; if (!alias) return;
      try { await apiPostJSON(API.semestersSelect, { alias }); location.reload(); }
      catch (e) { alert(e.message || "Failed to switch semester view."); }
    });
    btnViewReset?.addEventListener("click", async () => {
      try { await apiPostJSON(API.semestersSelect, { alias: null }); location.reload(); }
      catch (e) { alert(e.message || "Failed to reset view."); }
    });

    // ========================= Elements & helpers =========================
    const btnUpload = document.getElementById("btnUpload");
    const eoiFile = document.getElementById("eoiFile");
    const fileNameEl = document.getElementById("fileName");
    const eoiInfoRow = document.getElementById("eoiInfoRow");

    const btnProceed = document.getElementById("btnProceedAlloc");
    const allocFile = document.getElementById("allocFile");
    const allocFileName = document.getElementById("allocFileName");
    const allocInfoRow = document.getElementById("allocInfoRow");

    const unitsSection = document.getElementById("unitsSection");
    const unitsBody = document.getElementById("unitsBody");
    const recordCount = document.getElementById("recordCount");

    // --- Server status (authoritative) ---
    async function refreshUploadState(alias) {
      const st = await apiGet(API.importsStatus(alias)); // {has_eoi, has_sessions, last_*}

      // EOI state
      if (st.has_eoi) {
        btnUpload.disabled = true;
        btnUpload.classList.add("disabled");
        btnUpload.textContent = "EOI uploaded";
        fileNameEl.textContent = st.last_eoi?.filename || "";
        eoiInfoRow.innerHTML = `
          EOI data already exists for <b>${st.alias}</b>.
          To <b>overwrite</b> it, <button id="btnReuploadEOI" class="btn btn-link p-0 align-baseline">click here</button>.
        `;
        document.getElementById("btnReuploadEOI").addEventListener("click", () => {
          if (!confirm("This will overwrite existing EOI-derived data for this semester. Continue?")) return;
          btnUpload.disabled = false; btnUpload.classList.remove("disabled"); btnUpload.textContent = "Upload EOI Spreadsheet";
          eoiFile.value = ""; fileNameEl.textContent = "";
          eoiFile.click();
        });
      } else {
        btnUpload.disabled = false;
        btnUpload.classList.remove("disabled");
        btnUpload.textContent = "Upload EOI Spreadsheet";
        fileNameEl.textContent = "";
        eoiInfoRow.textContent = "";
      }

      // Master Class List / sessions state
      if (st.has_sessions) {
        btnProceed.onclick = () => location.href = `/allocationunits.html?alias=${encodeURIComponent(st.alias)}`;
        btnProceed.disabled = false;
        allocFileName.textContent = st.last_master_classes?.filename || "";
        allocInfoRow.innerHTML = `
          Master Class List already exists for <b>${st.alias}</b>.
          Click “Proceed to Tutor Allocation” to open existing data.
          To <b>overwrite</b> it, <button id="btnReuploadClass" class="btn btn-link p-0 align-baseline">click here</button>.
        `;
        document.getElementById("btnReuploadClass").addEventListener("click", () => {
          if (!confirm("Re-uploading will overwrite the current Master Class List for this semester. Continue?")) return;
          allocFile.value = ""; allocFileName.textContent = ""; allocInfoRow.textContent = "";
          btnProceed.onclick = proceedUploadOrRun;
          proceedUploadOrRun(new Event("dummy")); // prompt file picker
        });
      } else {
        // require upload path
        btnProceed.onclick = proceedUploadOrRun;
        allocInfoRow.textContent = "";
        allocFileName.textContent = "";
      }
      return st;
    }

    // ========================= EOI upload + preview =========================
    btnUpload.addEventListener("click", () => eoiFile.click());
    eoiFile.addEventListener("change", async () => {
      const f = eoiFile.files?.[0]; if (!f) return;
      fileNameEl.textContent = f.name;
      try {
        const fd = new FormData();
        fd.append("import_type", "eoi");
        fd.append("file", f);
        await apiPostForm(API.importsUpload, fd);

        const alias = await getCurrentAlias();
        sessionStorage.setItem("eoiPreviewAlias", alias);
        sessionStorage.setItem("eoiFileName", f.name);
        sessionStorage.setItem("eoiUploadDisabled", "1");

        btnUpload.disabled = true; btnUpload.classList.add("disabled"); btnUpload.textContent = "EOI uploaded";
        // re-sync from server so notes/flags are accurate
        await refreshUploadState(alias);
      } catch (e) { alert(e.message); }
      parseEOIToLocalPreview(f);
    });

    function parseEOIToLocalPreview(file) {
      const reader = new FileReader();
      const isCSV = /\.csv$/i.test(file.name);
      reader.onload = (e) => {
        const wb = isCSV ? XLSX.read(e.target.result, { type: "string" })
          : XLSX.read(new Uint8Array(e.target.result), { type: "array" });
        onWorkbookLoaded(wb);
      };
      isCSV ? reader.readAsText(file) : reader.readAsArrayBuffer(file);
    }
    function onWorkbookLoaded(wb) {
      const first = wb.SheetNames[0], sheet = wb.Sheets[first];
      const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
      if (!rows.length) { unitsSection.classList.remove("hidden"); recordCount.textContent = "0 Records Found"; return; }
      const headers = rows[0].map(h => String(h || "").trim().toLowerCase());
      const findCol = (...c) => {
        for (const k of c) {
          const key = k.toLowerCase();
          let i = headers.indexOf(key); if (i !== -1) return i;
          i = headers.findIndex(h => h.includes(key)); if (i !== -1) return i;
        } return -1;
      };
      const colApplied = findCol("please select up to five units", "applied unit", "units");
      if (colApplied === -1) { unitsBody.innerHTML = ""; unitsSection.classList.remove("hidden"); recordCount.textContent = "0 Records Found"; return; }
      const codeName = new Map(); const RX = /([A-Za-z]{3}\d{3})\s*(?:[-–—:\s]\s*)?([A-Za-z][^,;|]*)?/g;
      for (let r = 1; r < rows.length; r++) {
        const cell = String(rows[r][colApplied] || "").trim(); if (!cell) continue;
        RX.lastIndex = 0; let m; while ((m = RX.exec(cell)) !== null) {
          const code = m[1].toUpperCase(); let name = (m[2] || "").trim();
          name = name.replace(/\s+/g, " ").replace(/[,;|].*$/, "").trim(); if (!codeName.has(code)) codeName.set(code, name || code);
        }
      }
      const rowsArr = Array.from(codeName.entries()).sort((a, b) => a[0].localeCompare(b[0]));
      unitsBody.innerHTML = rowsArr.map(([code, name]) => {
        const url = `unitdetails.html?code=${encodeURIComponent(code)}&name=${encodeURIComponent(name)}`;
        return `<tr><td class="fw-semibold"><a class="text-decoration-none" href="${url}">${code}</a></td>
                    <td><a class="text-decoration-none" href="${url}">${name}</a></td></tr>`;
      }).join("");
      unitsSection.classList.remove("hidden");
      recordCount.textContent = `${rowsArr.length} Records Found`;
      sessionStorage.setItem("eoiUnits", JSON.stringify(rowsArr));
    }

    // ========================= Allocation workflow =========================
    function proceedUploadOrRun(e) {
      if (!allocFile.files?.length) { e?.preventDefault?.(); e?.stopPropagation?.(); allocFile.click(); }
      else { startAllocationWorkflow(); }
    }
    allocFile.addEventListener("change", () => {
      const f = allocFile.files?.[0]; if (f) { allocFileName.textContent = f.name; startAllocationWorkflow(); }
    });

    async function startAllocationWorkflow() {
      const f = allocFile.files?.[0]; if (!f) return;
      const original = btnProceed.innerHTML; btnProceed.disabled = true;
      try {
        btnProceed.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Uploading class times…`;
        const fd = new FormData(); fd.append("import_type", "master_class_list"); fd.append("file", f);
        await apiPostForm(API.importsUpload, fd);

        const alias = await getCurrentAlias();

        btnProceed.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Finalising EOI…`;
        await apiPostJSON(API.finalizeEOI(alias), {});

        btnProceed.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Running allocation…`;
        await apiPostJSON(API.runAllocation(alias), {});

        alert("Allocation completed.");
        location.href = `/allocationunits.html?alias=${encodeURIComponent(alias)}`;
      } catch (e) {
        alert(e.message || "Failed to run allocation.");
        btnProceed.disabled = false; btnProceed.innerHTML = original;
      }
    }

    // --- Users management button visibility (best effort) ---
    async function maybeShowUsersMgmt() {
      try {
        const res = await fetch('/api/accounts/profile/', { headers: authHeaders(), credentials: 'include' });
        if (!res.ok) return;
        const data = await res.json();
        const roles = Array.isArray(data?.roles) ? data.roles.map(r => r.name) : [];
        const isAdmin = !!data?.is_staff || roles.includes('Admin');
        if (isAdmin) document.getElementById('btnUsersMgmt')?.classList.remove('d-none');
      } catch { }
    }

    // ========================= Init =========================
    document.addEventListener("DOMContentLoaded", async () => {
      if (!token()) return (window.location.href = "/");
      await maybeShowAdminTools();
      await maybeShowUsersMgmt();
      await loadSemesters();

      try {
        const alias = await getCurrentAlias();
        await loadUnitsFromServerForAlias(alias);

        // sync UI with server-side status
        const st = await refreshUploadState(alias);

        // restore same-semester preview bits (non-authoritative)
        const savedAlias = sessionStorage.getItem("eoiPreviewAlias");
        if (savedAlias && savedAlias === alias) {
          const raw = sessionStorage.getItem("eoiUnits");
          if (raw) {
            const rowsArr = JSON.parse(raw);
            unitsBody.innerHTML = rowsArr.map(([code, name]) => {
              const url = `unitdetails.html?code=${encodeURIComponent(code)}&name=${encodeURIComponent(name)}`;
              return `<tr><td class="fw-semibold"><a class="text-decoration-none" href="${url}">${code}</a></td>
                          <td><a class="text-decoration-none" href="${url}">${name}</a></td></tr>`;
            }).join("");
            unitsSection.classList.remove("hidden");
            recordCount.textContent = `${rowsArr.length} Records Found`;
          }
          if (sessionStorage.getItem("eoiUploadDisabled") === "1" && !st.has_eoi) {
            btnUpload.disabled = true; btnUpload.classList.add("disabled"); btnUpload.textContent = "EOI uploaded";
            fileNameEl.textContent = sessionStorage.getItem("eoiFileName") || "";
          }
        } else {
          ["eoiUnits", "eoiPreviewAlias", "eoiUploadDisabled", "eoiFileName"].forEach(k => sessionStorage.removeItem(k));
        }
      } catch (e) { console.warn("init failed:", e); }
    });

    async function loadUnitsFromServerForAlias(alias) {
      try {
        const sessions = await apiGet(`/timetable/sessions/?alias=${encodeURIComponent(alias)}`);
        if (!Array.isArray(sessions) || !sessions.length) return;
        const byCode = new Map();
        sessions.forEach(s => {
          const code = (s.activity_code || s.unit_code || s.subject_code || "").toString().slice(0, 6).toUpperCase();
          if (!code) return;
          const name = (s.unit_name || s.subject_description || code).trim();
          if (!byCode.has(code)) byCode.set(code, name);
        });
        const rowsArr = Array.from(byCode.entries()).sort((a, b) => a[0].localeCompare(b[0]));
        unitsBody.innerHTML = rowsArr.map(([code, name]) => {
          const url = `unitdetails.html?code=${encodeURIComponent(code)}&name=${encodeURIComponent(name)}`;
          return `<tr><td class="fw-semibold"><a class="text-decoration-none" href="${url}">${code}</a></td>
                      <td><a class="text-decoration-none" href="${url}">${name}</a></td></tr>`;
        }).join("");
        unitsSection.classList.remove("hidden");
        recordCount.textContent = `${rowsArr.length} Records Found`;
      } catch (e) { console.warn("No server-side units found:", e); }
    }
  </script>
</body>

</html>