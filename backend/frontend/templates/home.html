<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Web Based Tutor Allocation System</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body {
      background: #fff;
    }

    .hero {
      min-height: 34vh;
      display: grid;
      place-items: center;
      text-align: center;
    }

    .btn-pill {
      border-radius: 999px;
    }

    .btn-wide {
      min-width: 240px;
    }

    .file-note {
      font-size: 0.9rem;
      color: #6b7280;
    }

    .hidden {
      display: none !important;
    }

    .table-wrap {
      max-width: 1000px;
    }

    .units-table tr {
      cursor: pointer;
    }

    .section-title {
      font-weight: 600;
      letter-spacing: 0.2px;
    }

    a.rowlink {
      text-decoration: none;
      color: inherit;
    }

    a.rowlink:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>
  <div class="container hero">
    <div>
      <h1 class="h5 fw-semibold mb-4">Web Based Tutor Allocation System</h1>

      <!-- Visible only to admins in JS once we fetch /api/users/me or decode JWT -->
      <div id="adminSemesterTools" class="card mb-3 d-none">
        <div class="card-body">
          <h5 class="card-title">Semester Databases</h5>
          <div class="row g-2 align-items-end">
            <div class="col-auto">
              <label class="form-label">Create new</label>
              <div class="input-group">
                <input id="semYear" type="number" class="form-control" placeholder="Year e.g. 2026" />
                <select id="semTerm" class="form-select">
                  <option value="S1">Semester 1</option>
                  <option value="S2">Semester 2</option>
                  <option value="S3">Semester 3</option>
                  <option value="S4">Semester 4</option>
                </select>
                <button id="btnCreateSem" class="btn btn-primary">Create & set current</button>
              </div>
            </div>
            <div class="col-auto">
              <label class="form-label">View semester (read-only)</label>
              <div class="input-group">
                <select id="semView" class="form-select"></select>
                <button id="btnViewApply" class="btn btn-outline-secondary">Apply</button>
                <button id="btnViewReset" class="btn btn-outline-secondary">Current</button>
              </div>
            </div>
          </div>
          <small class="text-muted">Uploads always go to the current semester. Old semesters are view-only.</small>
        </div>
      </div>
      <div class="d-flex flex-column align-items-center gap-2">
        <!-- EOI upload (original flow) -->
        <input id="eoiFile" type="file" class="d-none" accept=".xlsx,.xls,.csv" />
        <button id="btnUpload" class="btn btn-dark btn-pill btn-wide" type="button">
          Upload EOI Spreadsheet
        </button>
        <div id="fileName" class="file-note"></div>

        <!-- Tutor Allocations upload -->
        <input id="allocFile" type="file" class="d-none" accept=".xlsx,.xls,.csv" />
        <button id="btnProceedAlloc" class="btn btn-success btn-pill btn-wide mt-2" type="button">
          Proceed to Tutor Allocation
        </button>
        <div id="allocFileName" class="file-note"></div>
      </div>
    </div>
  </div>

  <!-- EOI units (Code + Name only) -->
  <div id="unitsSection" class="container table-wrap hidden">
    <div class="mb-2">
      <div class="section-title">Computing And Information Systems Units</div>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered align-middle units-table">
        <thead class="table-light">
          <tr>
            <th style="width: 160px">Code</th>
            <th>Name</th>
          </tr>
        </thead>
        <tbody id="unitsBody"></tbody>
      </table>
    </div>
    <div id="recordCount" class="small text-muted"></div>
  </div>

  <!-- Tutor Allocations: Code | Name | Staffs -->
  <div id="allocSection" class="container table-wrap hidden">
    <div class="mb-2">
      <div class="section-title">
        Computing And Information Systems Units For Semester 2, 2025
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th style="width: 160px">Code</th>
            <th>Name</th>
            <th style="width: 280px">Staffs</th>
          </tr>
        </thead>
        <tbody id="allocBody"></tbody>
      </table>
    </div>
    <div id="allocCount" class="small text-muted"></div>
  </div>

  <script>
    // =========================
    // Auth + request utilities
    // =========================
    const API = {
      base: "/api",
      // imports
      importsUpload: "/imports/upload/", // FormData: { import_type, file }
      // semesters
      semestersList: "/semesters/",
      semestersCreate: "/semesters/create/",
      semestersSelect: "/semesters/select/",
      // (optional) whoami endpoint — used to show/hide admin tools if available
      meCandidates: ["/users/me/", "/me/"],
    };

    const token = () => localStorage.getItem("access");
    const authHeaders = (extra = {}) =>
      token() ? { ...extra, Authorization: `Bearer ${token()}` } : extra;

    async function apiGet(path) {
      const res = await fetch(`${API.base}${path}`, {
        headers: authHeaders(),
        credentials: "include",
      });
      if (!res.ok) throw new Error(`GET ${path} failed (${res.status})`);
      return res.json();
    }

    async function apiPostJSON(path, body) {
      const res = await fetch(`${API.base}${path}`, {
        method: "POST",
        headers: authHeaders({ "Content-Type": "application/json" }),
        credentials: "include",
        body: JSON.stringify(body),
      });
      let payload = null;
      try { payload = await res.json(); } catch { }
      if (!res.ok) throw new Error(payload?.detail || payload?.error || `POST ${path} failed (${res.status})`);
      return payload ?? {};
    }

    async function apiPostForm(path, formData) {
      const res = await fetch(`${API.base}${path}`, {
        method: "POST",
        headers: authHeaders(),
        credentials: "include",
        body: formData,
      });
      let payload = null;
      try { payload = await res.json(); } catch { }
      if (!res.ok) throw new Error(payload?.detail || payload?.error || `Upload failed (${res.status})`);
      return payload ?? {};
    }

    // =========================
    // Admin tools visibility
    // =========================
    const adminCard = document.getElementById("adminSemesterTools");
    async function maybeShowAdminTools() {
      // Try a couple of common "me" endpoints; fall back to showing UI (server will still enforce perms)
      for (const p of API.meCandidates) {
        try {
          const me = await apiGet(p);
          const isAdmin =
            !!me?.is_staff ||
            (Array.isArray(me?.roles) && me.roles.includes("Admin")) ||
            me?.role === "Admin";
          if (isAdmin) adminCard.classList.remove("d-none");
          return;
        } catch { /* try next */ }
      }
      // Fallback (minimal change): show; server-side permission will block non-admins on POST
      adminCard.classList.remove("d-none");
    }

    // =========================
    // Semester APIs + UI wiring
    // =========================
    const semYearInput = document.getElementById("semYear");
    const semTermSelect = document.getElementById("semTerm");
    const btnCreateSem = document.getElementById("btnCreateSem");

    const semViewSelect = document.getElementById("semView");
    const btnViewApply = document.getElementById("btnViewApply");
    const btnViewReset = document.getElementById("btnViewReset");

    function labelForTerm(term) {
      // Accepts either S1/S2/… or full names, returns a compact label for the dropdown
      const t = String(term || "").toUpperCase().trim();
      if (t === "S1" || t.includes("SEMESTER 1")) return "S1";
      if (t === "S2" || t.includes("SEMESTER 2")) return "S2";
      if (t === "S3" || t.includes("SEMESTER 3")) return "S3";
      if (t === "S4" || t.includes("SEMESTER 4")) return "S4";
      if (t.includes("SPRING")) return "SPRING";
      if (t.includes("SUMMER")) return "SUMMER";
      if (t.includes("WINTER")) return "WINTER";
      return term || "TERM";
    }

    async function loadSemesters() {
      try {
        const list = await apiGet(API.semestersList);
        semViewSelect.innerHTML = "";
        (list || []).forEach((s) => {
          const opt = document.createElement("option");
          opt.value = s.alias; // e.g. backend alias like "2025_S2"
          const tag = s.is_current ? " (current)" : "";
          const termLabel = labelForTerm(s.term);
          opt.textContent = `${s.year} ${termLabel}${tag}`;
          semViewSelect.appendChild(opt);
        });
      } catch (e) {
        // Non-fatal to the rest of the page
        console.warn("Failed to load semesters:", e);
      }
    }

    btnCreateSem?.addEventListener("click", async () => {
      const year = Number(semYearInput.value);
      const term = semTermSelect.value; // S1/S2/S3/S4 (backend maps to full term)
      if (!year || year < 2000) return alert("Enter a valid year (e.g., 2026).");
      try {
        const created = await apiPostJSON(API.semestersCreate, {
          year,
          term,
          make_current: true,
        });
        alert(`Created ${created?.year} ${created?.term} and set as current.`);
        await loadSemesters();
      } catch (e) {
        alert(e.message || "Failed to create semester.");
      }
    });

    btnViewApply?.addEventListener("click", async () => {
      const alias = semViewSelect.value;
      if (!alias) return;
      try {
        await apiPostJSON(API.semestersSelect, { alias });
        // Reload so the backend-selected DB alias reflects in all reads
        location.reload();
      } catch (e) {
        alert(e.message || "Failed to switch semester view.");
      }
    });

    btnViewReset?.addEventListener("click", async () => {
      try {
        // Passing null tells backend to clear override and use current semester
        await apiPostJSON(API.semestersSelect, { alias: null });
        location.reload();
      } catch (e) {
        alert(e.message || "Failed to reset view.");
      }
    });

    // =========================
    // EOI upload -> backend + local preview (unchanged UX)
    // =========================
    const btnUpload = document.getElementById("btnUpload");
    const eoiFile = document.getElementById("eoiFile");
    const fileNameEl = document.getElementById("fileName");

    btnUpload.addEventListener("click", () => eoiFile.click());
    eoiFile.addEventListener("change", async () => {
      const f = eoiFile.files?.[0];
      if (!f) return;
      fileNameEl.textContent = f.name;

      // 1) send to backend — will write into the CURRENT semester DB
      try {
        const fd = new FormData();
        fd.append("import_type", "eoi");
        fd.append("file", f);
        await apiPostForm(API.importsUpload, fd);
      } catch (e) {
        alert(e.message);
      }

      // 2) local preview keeps your original flow
      parseEOIToLocalPreview(f);
    });

    // === Local EOI preview helpers (existing logic kept) ===
    const unitsSection = document.getElementById("unitsSection");
    const unitsBody = document.getElementById("unitsBody");
    const recordCount = document.getElementById("recordCount");
    let workbook = null;
    let unitSheets = [];

    function parseEOIToLocalPreview(file) {
      const reader = new FileReader();
      const isCSV = /\.csv$/i.test(file.name);
      reader.onload = (e) => {
        let wb;
        if (isCSV) wb = XLSX.read(e.target.result, { type: "string" });
        else wb = XLSX.read(new Uint8Array(e.target.result), { type: "array" });
        onWorkbookLoaded(wb);
      };
      isCSV ? reader.readAsText(file) : reader.readAsArrayBuffer(file);
    }

    function onWorkbookLoaded(wb) {
      workbook = wb;
      const payload = {};
      wb.SheetNames.forEach((name) => {
        payload[name] = XLSX.utils.sheet_to_json(wb.Sheets[name], { header: 1, defval: "" });
      });
      try { localStorage.setItem("eoi_sheets_aoa", JSON.stringify(payload)); } catch { }

      unitSheets = wb.SheetNames.map((sheetName) => {
        const sheet = wb.Sheets[sheetName];
        let b1 = sheet["B1"] ? String(sheet["B1"].v || sheet["B1"].w || "").trim() : "";
        if (!b1) b1 = scanTopForCodeTitle(sheet);
        let code = "", name = "";
        if (b1) {
          const m = b1.match(/^([A-Za-z]{3}\d{3,})\s+(.+)$/);
          if (m) { code = m[1].trim(); name = m[2].trim(); }
          else if (/^[A-Za-z]{3}\d{3,}$/.test(b1)) code = b1;
          else name = b1;
        }
        if (!code) {
          const mm = sheetName.match(/^([A-Za-z]{3}\d{3,})/);
          if (mm) code = mm[1];
        }
        if (!name) name = sheetName;
        const title = `${code || ""} ${name || ""}`.trim();
        return { sheetName, code, name, title };
      });

      const seen = new Set();
      unitSheets = unitSheets
        .filter((u) => { const k = `${u.code}||${u.name}`; if (seen.has(k)) return false; seen.add(k); return true; })
        .sort((a, b) => (a.code || "").localeCompare(b.code || "") || (a.name || "").localeCompare(b.name || ""));
      renderUnits();
    }

    function renderUnits() {
      unitsBody.innerHTML = "";
      unitSheets.forEach((u) => {
        const url = `unitdetails.html?sheet=${encodeURIComponent(u.sheetName)}&title=${encodeURIComponent(u.title)}&code=${encodeURIComponent(u.code)}&name=${encodeURIComponent(u.name)}`;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="fw-semibold"><a class="text-decoration-none" href="${url}">${u.code || ""}</a></td>
          <td><a class="text-decoration-none" href="${url}">${u.name || ""}</a></td>`;
        unitsBody.appendChild(tr);
      });
      unitsSection.classList.remove("hidden");
      recordCount.textContent = `${unitSheets.length} Records Found`;
    }

    function scanTopForCodeTitle(sheet) {
      const maxR = 6, maxC = 6;
      for (let r = 1; r <= maxR; r++) for (let c = 1; c <= maxC; c++) {
        const addr = XLSX.utils.encode_cell({ r: r - 1, c: c - 1 });
        const cell = sheet[addr]; if (!cell) continue;
        const v = String(cell.v || cell.w || "").trim();
        if (/^[A-Za-z]{3}\d{3,}\s+.+$/.test(v)) return v;
      }
      return "";
    }

    // =========================
    // Tutor allocations upload
    // =========================
    const btnProceedAlloc = document.getElementById("btnProceedAlloc");
    const allocFile = document.getElementById("allocFile");
    const allocFileName = document.getElementById("allocFileName");
    const allocSection = document.getElementById("allocSection");
    const allocBody = document.getElementById("allocBody");
    const allocCount = document.getElementById("allocCount");
    let __allocAOA = null;

    btnProceedAlloc.addEventListener("click", () => allocFile.click());
    allocFile.addEventListener("change", async () => {
      const f = allocFile.files?.[0];
      if (!f) return;
      allocFileName.textContent = f.name;

      // 1) send to backend — will write into the CURRENT semester DB
      try {
        const fd = new FormData();
        fd.append("import_type", "tutorial_allocations");
        fd.append("file", f);
        await apiPostForm(API.importsUpload, fd);
      } catch (e) {
        alert(e.message);
      }

      // 2) local preview
      const reader = new FileReader();
      const isCSV = /\.csv$/i.test(f.name);
      reader.onload = (e) => {
        let wb;
        if (isCSV) wb = XLSX.read(e.target.result, { type: "string" });
        else wb = XLSX.read(new Uint8Array(e.target.result), { type: "array" });

        __allocAOA = {};
        wb.SheetNames.forEach((n) => {
          __allocAOA[n] = XLSX.utils.sheet_to_json(wb.Sheets[n], { header: 1, defval: "" });
        });
        try { localStorage.setItem("alloc_sheets_aoa", JSON.stringify(__allocAOA)); } catch { }

        const list = buildAllocList(wb);
        renderAlloc(list);
      };
      isCSV ? reader.readAsText(f) : reader.readAsArrayBuffer(f);
    });

    function buildAllocList(wb) {
      const out = [];
      wb.SheetNames.forEach((sheetName) => {
        const sh = wb.Sheets[sheetName];
        const aoa = XLSX.utils.sheet_to_json(sh, { header: 1, defval: "" });
        if (!aoa.length) return;

        const wanted = ["subject_code", "subject code", "subject_description", "subject description", "activity_code", "campus", "location", "staff", "staffs", "tutor", "tutors", "teacher", "instructor"];
        let h = -1;
        let cols = { code: -1, name: -1, staff: -1 };
        for (let r = 0; r < Math.min(200, aoa.length); r++) {
          const lower = aoa[r].map((c) => String(c).trim().toLowerCase());
          const hits = wanted.filter((w) => lower.includes(w)).length;
          if (hits >= 2) {
            h = r;
            cols.code = indexOfAny(lower, ["subject_code", "subject code"]);
            cols.name = indexOfAny(lower, ["subject_description", "subject description", "unit name", "subject name"]);
            cols.staff = indexOfAny(lower, ["staff", "staffs", "tutor", "tutors", "teacher", "instructor"]);
            break;
          }
        }

        let code = "", name = "", staffStr = "";
        if (h !== -1) {
          for (let r = h + 1; r < aoa.length; r++) {
            const row = aoa[r];
            if (row.some((x) => String(x).trim() !== "")) {
              if (cols.code >= 0) {
                const raw = String(row[cols.code] || "").trim();
                const m = raw.match(/[A-Za-z]{3}\d{3}/); code = m ? m[0] : raw;
              }
              if (cols.name >= 0) name = String(row[cols.name] || "").trim();
              break;
            }
          }
          if (cols.staff >= 0) {
            const names = [];
            for (let r = h + 1; r < aoa.length; r++) {
              const v = (aoa[r][cols.staff] || "").toString().trim();
              if (!v) continue;
              v.split(/[;,/]+/).map((s) => s.trim()).filter(Boolean).forEach((n) => {
                if (!names.includes(n)) names.push(n);
              });
            }
            staffStr = names.slice(0, 3).join(", ");
          }
        }
        if (!code) {
          const b1 = sh["B1"] ? String(sh["B1"].v || sh["B1"].w || "").trim() : "";
          const m1 = b1.match(/[A-Za-z]{3}\d{3}/); if (m1) code = m1[0];
        }
        if (!code) {
          const mm = sheetName.match(/[A-Za-z]{3}\d{3}/); if (mm) code = mm[0];
        }
        if (!name) name = sheetName;

        if (code || name) out.push({ sheetName, code, name, staff: staffStr });
      });
      return out.filter((r) => r.code || r.name);

      function indexOfAny(arr, keys) {
        for (const k of keys) { const i = arr.indexOf(k); if (i !== -1) return i; }
        return -1;
      }
    }

    function renderAlloc(list) {
      allocBody.innerHTML = "";
      const seen = new Set();
      const uniq = list
        .filter((r) => { const k = `${r.code}||${r.name}`; if (seen.has(k)) return false; seen.add(k); return true; })
        .sort((a, b) => (a.code || "").localeCompare(b.code || "") || (a.name || "").localeCompare(b.name || ""));

      uniq.forEach((r) => {
        const href = `allocationdetails.html?sheet=${encodeURIComponent(r.sheetName)}&code=${encodeURIComponent(r.code)}&name=${encodeURIComponent(r.name)}`;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="fw-semibold"><a class="rowlink" href="${href}">${r.code || ""}</a></td>
          <td><a class="rowlink" href="${href}">${r.name || ""}</a></td>
          <td><a class="rowlink" href="${href}"><strong>${r.staff || ""}</strong></a></td>`;
        tr.querySelectorAll("a").forEach((a) => {
          a.addEventListener("click", () => {
            try {
              if (__allocAOA && __allocAOA[r.sheetName]) {
                sessionStorage.setItem("alloc_sheet_current", JSON.stringify({ key: r.sheetName, rows: __allocAOA[r.sheetName] }));
              }
            } catch { }
          });
        });
        allocBody.appendChild(tr);
      });

      allocSection.classList.remove("hidden");
      allocCount.textContent = `${uniq.length} Records Found`;
    }

    // =========================
    // Page init
    // =========================
    document.addEventListener("DOMContentLoaded", async () => {
      if (!token()) return (window.location.href = "/"); // require login
      await maybeShowAdminTools();
      await loadSemesters();
    });
  </script>

</body>

</html>