<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Tutor Search - Web Based Tutor Allocation</title>

    <!-- Google Font (optional) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        :root {
            --heading-color: #101828;
            --muted: #475467;
            --brand: #3c5825;
            --brand-hover: #324a1f;
            --field-radius: 12px;
            --btn-radius: 12px;
        }

        body {
            font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto,
                "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji",
                "Segoe UI Emoji", "Segoe UI Symbol";
            background: #f8f9fa;
        }

        .container {
            max-width: 900px;
        }

        .search-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .result-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            transition: box-shadow 0.2s ease;
        }

        .result-card:hover {
            box-shadow: 0 4px 12px -2px rgba(0, 0, 0, 0.1);
        }

        .form-control {
            border-radius: var(--field-radius);
            border: 2px solid #d1d5db;
            padding: 12px 16px;
            font-size: 16px;
        }

        .form-control:focus {
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(60, 88, 37, 0.1);
        }

        .btn-primary {
            background-color: var(--brand);
            border-color: var(--brand);
            border-radius: var(--btn-radius);
            padding: 12px 24px;
            font-weight: 600;
        }

        .btn-primary:hover {
            background-color: var(--brand-hover);
            border-color: var(--brand-hover);
        }

        .badge {
            border-radius: 6px;
        }

        .loading-spinner {
            display: none;
        }

        .error-alert {
            display: none;
        }

        .results-section {
            display: none;
        }

        .unit-badge {
            background-color: #e0f2fe;
            color: #01579b;
            border: 1px solid #b3e5fc;
        }

        .campus-badge {
            background-color: #f3e5f5;
            color: #4a148c;
            border: 1px solid #e1bee7;
        }

        .session-info {
            font-size: 0.875rem;
            color: var(--muted);
        }
    </style>
</head>

<body>
    <div class="container py-5">
        <!-- Header -->
        <div class="text-center mb-5">
            <h1 class="h2 mb-3" style="color: var(--heading-color); font-weight: 700;">Tutor Search</h1>
            <p class="text-muted">Search for tutors</p>

            <!-- Quick Navigation -->
            <div class="mt-3">
                <div class="d-flex gap-2 justify-content-center flex-wrap">
                    <a href="/tutor-search/" class="btn btn-outline-primary btn-sm">
                        Search Tutors
                    </a>
                    <a href="/tutor-list/" id="btnListAll" class="btn btn-outline-success btn-sm">
                        List All Tutors
                    </a>
                    <a href="/home/" class="btn btn-outline-secondary btn-sm">
                        Home
                    </a>
                </div>
            </div>
        </div>

        <!-- Search Form -->
        <div class="search-card p-4 mb-4">
            <form id="searchForm">
                <div class="row g-3 align-items-end">
                    <div class="col-md-8">
                        <label for="emailSelect" class="form-label fw-semibold">Tutor</label>

                        <!-- quick filter input -->
                        <div class="dropdown w-100">
                            <button id="tutorPickerBtn"
                                class="form-control text-start d-flex justify-content-between align-items-center"
                                data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                                <span id="tutorPickerLabel">Choose an allocated tutorâ€¦</span>
                                <i class="bi bi-caret-down-fill ms-2"></i>
                            </button>

                            <div id="tutorPickerMenu" class="dropdown-menu p-0 w-100">
                                <!-- Search box INSIDE the dropdown -->
                                <div class="p-2 border-bottom">
                                    <input id="tutorPickerFilter" type="text" class="form-control"
                                        placeholder="Type tutor name to filterâ€¦">
                                </div>
                                <!-- Scrollable list of tutors -->
                                <div id="tutorPickerList" class="list-group list-group-flush"
                                    style="max-height:260px; overflow:auto;"></div>
                            </div>
                        </div>

                        <!-- Keep the original select for form submission (hidden) -->
                        <select id="emailSelect" class="d-none" required>
                            <option value="" selected disabled>Choose an allocated tutorâ€¦</option>
                        </select>

                        <small class="text-muted">
                            Dropdown shows only tutors who are actually allocated to a class (any semester).
                        </small>
                    </div>
                    <div class="col-md-4">
                        <button type="submit" class="btn btn-primary w-100">
                            <span class="btn-text">Search Tutor</span>
                            <div class="loading-spinner spinner-border spinner-border-sm ms-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Error Alert -->
        <div class="alert alert-danger error-alert" role="alert">
            <strong>Error:</strong> <span id="errorMessage"></span>
        </div>

        <!-- Results Section -->
        <div class="results-section">
            <!-- Tutor Info -->
            <div class="result-card p-4 mb-4">
                <div class="d-flex align-items-center mb-3">
                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-3"
                        style="width: 50px; height: 50px;">
                        <i class="text-white">ðŸ‘¤</i>
                    </div>
                    <div>
                        <h3 class="h5 mb-1" id="tutorName">-</h3>
                        <p class="text-muted mb-0" id="tutorEmail">-</p>
                    </div>
                </div>
            </div>

            <!-- Allocation Units -->
            <div class="result-card p-4">
                <h5 class="mb-3">Unit Allocations</h5>
                <div id="allocationsList"></div>
            </div>
        </div>

        <!-- No Results Message -->
        <div class="text-center py-5 d-none" id="noResultsMessage">
            <div class="text-muted">
                <h5>No tutor found</h5>
                <p>Try searching with a different email address.</p>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // =========================
        // Auth + request helpers
        // =========================
        const getAccessToken = () => localStorage.getItem("access");
        const authHeaders = (extra = {}) => {
            const token = getAccessToken();
            return token ? { ...extra, Authorization: `Bearer ${token}` } : extra;
        };

        document.addEventListener("DOMContentLoaded", () => {
            if (!getAccessToken()) { window.location.href = "/"; return; }

            // populate dropdown immediately
            loadAllocatedTutors();

            const filterInput = document.getElementById('tutorPickerFilter');
            document.getElementById('tutorPickerBtn').addEventListener('shown.bs.dropdown', () => {
                setTimeout(() => filterInput.focus(), 10);
            });

            filterInput.addEventListener('input', () => {
                const q = filterInput.value.trim().toLowerCase();
                const filtered = !q
                    ? ALL_TUTORS
                    : ALL_TUTORS.filter(t => {
                        const full = `${t.first_name || ''} ${t.last_name || ''}`.trim().toLowerCase();
                        // allow multi-word queries in any order
                        return q.split(/\s+/).filter(Boolean).every(tok => full.includes(tok));
                    });
                renderTutorList(filtered);
            });
            // prevent Enter from submitting the main form while filtering
            filterInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') e.preventDefault();
            });
            // If navigated from "List all tutors", auto-run the search by ?email=...
            const params = new URLSearchParams(location.search);
            const prefillEmail = (params.get("email") || "").trim();
            if (prefillEmail) {
                // Run the search immediately without requiring the dropdown value
                (async () => {
                    showLoading(true);
                    hideError();
                    hideResults();
                    try {
                        const response = await fetch(`/api/allocation/tutor/search/?email=${encodeURIComponent(prefillEmail)}`, {
                            method: "GET",
                            headers: authHeaders({ "Content-Type": "application/json" }),
                        });
                        if (response.ok) {
                            const data = await response.json();
                            displayResults(data);
                        } else if (response.status === 401) {
                            window.location.href = "/";
                        } else {
                            const errorData = await response.json();
                            showError(errorData.detail || "An error occurred while searching for the tutor.");
                        }
                    } catch (error) {
                        console.error("Search error:", error);
                        showError("A network error occurred. Please check your connection and try again.");
                    } finally {
                        showLoading(false);
                    }
                })();
            }

            document.getElementById("searchForm").addEventListener("submit", async function (e) {
                e.preventDefault();
                const sel = document.getElementById("emailSelect");
                const email = (sel.value || "").trim();
                if (!email) return;

                showLoading(true);
                hideError();
                hideResults();

                try {
                    const response = await fetch(`/api/allocation/tutor/search/?email=${encodeURIComponent(email)}`, {
                        method: "GET",
                        headers: authHeaders({ "Content-Type": "application/json" }),
                    });

                    if (response.ok) {
                        const data = await response.json();
                        displayResults(data);
                    } else if (response.status === 401) {
                        window.location.href = "/";
                    } else {
                        const errorData = await response.json();
                        showError(errorData.detail || "An error occurred while searching for the tutor.");
                    }
                } catch (error) {
                    console.error("Search error:", error);
                    showError("A network error occurred. Please check your connection and try again.");
                } finally {
                    showLoading(false);
                }
            });
        });

        async function loadAllocatedTutors() {
            try {
                const resp = await fetch('/api/allocation/tutor/allocated-emails/', {
                    headers: authHeaders({ 'Content-Type': 'application/json' }),
                });
                if (!resp.ok) return;
                ALL_TUTORS = await resp.json();   // keep full list
                renderTutorList(ALL_TUTORS);      // initial render
            } catch (e) {
                console.error('Load allocated tutors failed:', e);
            }
        }

        let ALL_TUTORS = [];

        function renderTutorList(items) {
            const listEl = document.getElementById('tutorPickerList');
            const sel = document.getElementById('emailSelect');
            const label = document.getElementById('tutorPickerLabel');
            const current = sel.value;

            listEl.innerHTML = '';
            sel.innerHTML = `<option value="" disabled ${current ? '' : 'selected'}>Choose an allocated tutorâ€¦</option>`;

            items.forEach(t => {
                const fullName = `${t.first_name || ''} ${t.last_name || ''}`.trim();
                const text = fullName ? `${t.email} â€” ${fullName}` : t.email;

                // visual list item (click -> choose)
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'list-group-item list-group-item-action';
                btn.textContent = text;
                btn.addEventListener('click', () => {
                    sel.value = t.email;               // keep form behavior unchanged
                    label.textContent = text;          // show chosen label
                    bootstrap.Dropdown.getOrCreateInstance(
                        document.getElementById('tutorPickerBtn')
                    ).hide();
                });
                listEl.appendChild(btn);

                // hidden <option> for form submit
                const opt = document.createElement('option');
                opt.value = t.email;
                opt.textContent = text;
                sel.appendChild(opt);
            });

            if (current && items.some(i => i.email === current)) {
                const chosen = items.find(i => i.email === current);
                const name = `${chosen.first_name || ''} ${chosen.last_name || ''}`.trim();
                label.textContent = name ? `${chosen.email} â€” ${name}` : chosen.email;
            } else if (!current) {
                label.textContent = 'Choose an allocated tutorâ€¦';
            }
        }

        function showLoading(show) {
            const spinner = document.querySelector(".loading-spinner");
            const btnText = document.querySelector(".btn-text");
            const submitBtn = document.querySelector('button[type="submit"]');

            if (show) {
                spinner.style.display = "inline-block";
                btnText.textContent = "Searching...";
                submitBtn.disabled = true;
            } else {
                spinner.style.display = "none";
                btnText.textContent = "Search Tutor";
                submitBtn.disabled = false;
            }
        }

        function showError(message) {
            const errorAlert = document.querySelector(".error-alert");
            const errorMessage = document.getElementById("errorMessage");
            errorMessage.textContent = message;
            errorAlert.style.display = "block";
        }

        function hideError() {
            const errorAlert = document.querySelector(".error-alert");
            errorAlert.style.display = "none";
        }

        function hideResults() {
            const resultsSection = document.querySelector(".results-section");
            const noResultsMessage = document.getElementById("noResultsMessage");
            resultsSection.style.display = "none";
            noResultsMessage.classList.add("d-none");
        }

        function displayResults(data) {
            if (!data || !data.tutor) {
                const noResultsMessage = document.getElementById('noResultsMessage');
                noResultsMessage.classList.remove('d-none');
                return;
            }

            // Tutor header
            document.getElementById("tutorName").textContent = data.tutor.full_name || (data.tutor.email || "-");
            document.getElementById("tutorEmail").textContent = data.tutor.email || "-";

            // remove campus area completely (we already removed the HTML)

            // Grouped allocations by semester
            const host = document.getElementById("allocationsList");
            host.innerHTML = "";

            const groups = Array.isArray(data.semesters) ? data.semesters : [];
            if (!groups.length) {
                host.innerHTML = '<div class="text-muted text-center py-3">No allocations found in any semester</div>';
            } else {
                groups.forEach(group => {
                    const alias = group.alias || "(unknown)";
                    const entries = Array.isArray(group.allocations) ? group.allocations : [];

                    const wrap = document.createElement("div");
                    wrap.className = "border rounded p-3 mb-3";

                    const header = document.createElement("div");
                    header.className = "d-flex justify-content-between align-items-center mb-2";
                    header.innerHTML = `<h6 class="mb-0">Semester: ${alias}</h6>
                                <span class="badge unit-badge">${entries.length} class${entries.length === 1 ? "" : "es"}</span>`;
                    wrap.appendChild(header);

                    if (!entries.length) {
                        const empty = document.createElement("div");
                        empty.className = "text-muted";
                        empty.textContent = "No classes in this semester.";
                        wrap.appendChild(empty);
                    } else {
                        entries.forEach(row => {
                            const line = document.createElement("div");
                            line.className = "d-flex justify-content-between align-items-start py-1 border-top";

                            // Line 1: e.g., "KIT101 â€” Programming Fundamentals"
                            const firstLine = `<strong>${row.unit_code}</strong> â€” ${row.unit_name || ""}`;

                            const secondLineParts = [];
                            if (row.campus) {
                                secondLineParts.push(`<span>${row.campus}</span>`);
                            }
                            if (row.activity_code) {
                                secondLineParts.push(`<span class="text-uppercase">${row.activity_code}</span>`);
                            }

                            const timeString = `${row.day || ''} ${row.start_time || ''}${row.end_time ? `â€“${row.end_time}` : ''}`.trim();
                            if (timeString) {
                                secondLineParts.push(`<span>${timeString}</span>`);
                            }

                            const secondLine = secondLineParts.join(' <span class="text-muted mx-2">|</span> ');

                            line.innerHTML = `
                                <div>
                                    <div>${firstLine}</div>
                                    <div class="session-info">${secondLine}</div>
                                </div>
                                <div class="text-muted">#${row.session_id ?? ""}</div>
                            `;
                            wrap.appendChild(line);
                        });
                    }

                    host.appendChild(wrap);
                });
            }

            // show results
            document.querySelector(".results-section").style.display = "block";
        }

    </script>
</body>

</html>