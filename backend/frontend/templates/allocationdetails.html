<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Allocation Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .campus-title {
      background: #fde047;
      padding: 0.35rem 0.6rem;
      font-weight: 600;
      display: inline-block;
      border-radius: 0.25rem;
      margin: 0.25rem 0 0.5rem;
    }

    .cell-input {
      min-width: 160px;
    }

    .notes-input {
      min-width: 220px;
    }

    .small-hint {
      font-size: 0.8rem;
      color: #6b7280;
    }

    .actions {
      border-top: 1px solid #e5e7eb;
    }

    .staff-chip {
      display: inline-block;
      margin: 0.1rem 0.25rem 0.1rem 0;
      padding: 0.15rem 0.45rem;
      border-radius: 999px;
      background: #e9f2ff;
      color: #0b5ed7;
      cursor: pointer;
      font-size: 0.85rem;
    }

    /* Timetable */
    .tt-grid {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: fixed;
    }

    .tt-grid th,
    .tt-grid td {
      border: 1px solid #e5e7eb;
    }

    .tt-grid thead th {
      background: #f8fafc;
      text-align: center;
    }

    .tt-time {
      width: 90px;
      background: #f3f4f6;
      font-weight: 600;
    }

    .tt-slot {
      height: 56px;
      position: relative;
    }

    /* 56px per hour */
    .tt-event {
      position: absolute;
      left: 6px;
      right: 6px;
      border-radius: 0.25rem;
      padding: 0.25rem 0.35rem;
      background: #facc15;
      color: #111827;
      font-size: 0.8rem;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
  </style>
</head>

<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h1 id="title" class="h5 m-0">Unit</h1>
        <div class="small-hint">
          Click <strong>EDIT</strong> to update Staff / Notes, then
          <strong>SUBMIT</strong> to save. Click a
          <span class="staff-chip" style="cursor: default; background: #eef6ff; color: #0b5ed7">staff name</span>
          to view timetable.
        </div>
      </div>
      <a href="home.html" class="btn btn-outline-secondary">← Back to Units</a>
    </div>

    <div id="content"></div>

    <div id="noData" class="alert alert-warning d-none mt-3">
      No allocation data found. Please upload “Tutorial Allocations.xlsx” on
      the home page first and click a unit again.
    </div>

    <!-- Actions -->
    <div class="actions pt-3 mt-2 d-flex justify-content-center gap-2">
      <button id="btnEdit" class="btn btn-danger px-5">EDIT</button>
      <button id="btnSubmit" class="btn btn-primary px-5 d-none">
        SUBMIT
      </button>
    </div>
  </div>

  <!-- Timetable Modal -->
  <div class="modal fade" id="ttModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="ttTitle">Timetable</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="ttContainer"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    /* ---------------- Auth / API helpers ---------------- */
    const API_BASE = "/api";
    const token = () => localStorage.getItem("access");
    const authHeaders = (extra = {}) => token() ? { ...extra, Authorization: `Bearer ${token()}` } : extra;

    async function apiGet(path) {
      const res = await fetch(`${API_BASE}${path}`, { headers: authHeaders(), credentials: "include" });
      let data = null; try { data = await res.json(); } catch { }
      if (res.status === 401) { window.location = "/"; throw new Error("Unauthorized"); }
      if (!res.ok) throw new Error(data?.detail || `GET ${path} -> ${res.status}`);
      return data;
    }

    async function apiPost(path, body) {
      const res = await fetch(`${API_BASE}${path}`, {
        method: "POST",
        headers: authHeaders({ "Content-Type": "application/json" }),
        body: JSON.stringify(body)
      });
      let data = null; try { data = await res.json(); } catch { }
      if (res.status === 401) { window.location = "/"; throw new Error("Unauthorized"); }
      if (!res.ok) throw new Error(data?.detail || `POST ${path} -> ${res.status}`);
      return data;
    }

    /* ---------------- Query params ---------------- */
    const qs = new URLSearchParams(location.search);
    const alias = qs.get("alias") || "";
    const code = (qs.get("code") || "").toUpperCase();
    const campus = qs.get("campus") || "";

    document.getElementById("title").textContent = code || "Unit";

    /* ---------------- Page init ---------------- */
    document.addEventListener("DOMContentLoaded", init);

    async function init() {
      try {
        const sessions = await apiGet(`/timetable/sessions/?alias=${encodeURIComponent(alias)}&unit_code=${encodeURIComponent(code)}&campus=${encodeURIComponent(campus)}`);
        if (!sessions.length) {
          document.getElementById("noData").classList.remove("d-none");
          return;
        }
        renderSessions(sessions);
        wireEditing(sessions);
      } catch (e) {
        console.error(e);
        alert("Failed to load sessions: " + e.message);
      }
    }

    /* ---------------- Render sessions ---------------- */
    function renderSessions(sessions) {
      const wrap = document.createElement("div");
      wrap.className = "table-responsive";
      const table = document.createElement("table");
      table.className = "table table-bordered align-middle";

      const thead = document.createElement("thead");
      thead.innerHTML = `<tr>
      <th>Activity</th><th>Day</th><th>Start</th><th>Weeks</th><th>Duration</th><th>Location</th>
      <th>Staff</th><th>Notes</th>
    </tr>`;
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      sessions.forEach(s => {
        const tr = document.createElement("tr");
        tr.dataset.sessionId = s.session_id;

        tr.innerHTML = `
        <td>${s.activity_code || ""}</td>
        <td>${s.day_of_week || ""}</td>
        <td>${s.start_time || ""}</td>
        <td>${s.weeks || ""}</td>
        <td>${s.duration || ""}</td>
        <td>${s.location || ""}</td>
        <td>
          <input type="text" class="form-control form-control-sm staff-input d-none" placeholder="Start typing a tutor..." disabled>
          <div class="staff-display">${s.tutor || ""}</div>
        </td>
        <td>
          <input type="text" class="form-control form-control-sm notes-input" value="${s.notes || ""}" disabled>
        </td>
      `;
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      wrap.appendChild(table);
      document.getElementById("content").appendChild(wrap);
    }

    /* ---------------- Editing logic ---------------- */
    let isEditing = false;
    const btnEdit = document.getElementById("btnEdit");
    const btnSubmit = document.getElementById("btnSubmit");

    function wireEditing(sessions) {
      btnEdit.addEventListener("click", () => {
        isEditing = true;
        document.querySelectorAll(".staff-input, .notes-input").forEach(i => i.disabled = false);
        document.querySelectorAll(".staff-input").forEach(i => i.classList.remove("d-none"));
        document.querySelectorAll(".staff-display").forEach(d => d.classList.add("d-none"));
        btnSubmit.classList.remove("d-none");
      });

      btnSubmit.addEventListener("click", async () => {
        try {
          const rows = document.querySelectorAll("tr[data-session-id]");
          for (const tr of rows) {
            const sessionId = tr.dataset.sessionId;
            const staffInput = tr.querySelector(".staff-input");
            const notesInput = tr.querySelector(".notes-input");

            // Prefer an ID from a picked suggestion
            let tutorUserId = staffInput.dataset.userId ? parseInt(staffInput.dataset.userId, 10) : null;
            let tutorEmail = staffInput.dataset.email || "";

            // If they typed manually and didn't pick, try to extract an email from the text
            if (!tutorUserId && !tutorEmail) {
              const m = staffInput.value.match(/[\w\.\-\+]+@[\w\.\-]+\.\w+/);
              if (m) tutorEmail = m[0];
            }

            const body = {
              session_id: Number(sessionId),
              notes: notesInput.value || ""
            };
            if (staffInput.dataset.userId) body.tutor_user_id = parseInt(staffInput.dataset.userId, 10);
            if (staffInput.dataset.email) body.tutor_email = staffInput.dataset.email;
            await apiPost(`/allocation/assign/?alias=${encodeURIComponent(alias)}`, body);
          }
          alert("Assignments saved.");
          location.reload();
        } catch (e) {
          alert("Error: " + e.message);
        }
      });

      // attach live suggestions for staff inputs
      document.querySelectorAll(".staff-input").forEach(inp => {
        inp.addEventListener("input", () => suggestTutors(inp));
      });
    }

    /* ---------------- Tutor suggestions ---------------- */
    async function suggestTutors(inputEl) {
      const q = inputEl.value.trim();
      if (!q) return;

      const list = await apiGet(`/allocation/suggest_tutors/?alias=${alias}&unit_code=${code}&campus=${campus}&q=${encodeURIComponent(q)}`);

      // build/update a datalist under the input
      let dl = inputEl.nextElementSibling;
      if (!dl || dl.tagName !== "DATALIST") {
        dl = document.createElement("datalist");
        dl.id = "dl-" + Math.random().toString(36).slice(2);
        inputEl.setAttribute("list", dl.id);
        inputEl.after(dl);
      }

      // Keep BOTH id and email on each option
      dl.innerHTML = list.map(t =>
        `<option data-id="${t.id}" data-email="${t.email}" value="${t.name} (${t.email})${t.preference ? " — pref " + t.preference : ""}"></option>`
      ).join("");

      // whenever a value is chosen, copy id/email into data-attrs on the input
      inputEl.addEventListener("change", () => {
        const opt = Array.from(dl.options).find(o => o.value === inputEl.value);
        if (opt) {
          inputEl.dataset.userId = opt.dataset.id || "";
          inputEl.dataset.email = opt.dataset.email || "";
        } else {
          // clear if they typed something else
          inputEl.dataset.userId = "";
          inputEl.dataset.email = "";
        }
      }, { once: true });
    }

  </script>

</body>

</html>