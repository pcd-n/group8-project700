<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Allocation Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .small-hint {
      font-size: .8rem;
      color: #6b7280
    }

    .actions {
      border-top: 1px solid #e5e7eb
    }

    .staff-chip {
      display: inline-block;
      margin: .1rem .25rem .1rem 0;
      padding: .15rem .45rem;
      border-radius: 999px;
      background: #e9f2ff;
      color: #0b5ed7;
      cursor: pointer;
      font-size: .85rem
    }

    .notes-input {
      min-width: 220px
    }
  </style>
</head>

<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h1 id="title" class="h5 m-0">Unit</h1>
        <div class="small-hint">
          Click <strong>EDIT</strong> to update Tutors / Notes, then <strong>SUBMIT</strong> to save.
          Click a <span class="staff-chip" style="cursor:default;background:#eef6ff;color:#0b5ed7">staff name</span> to
          view timetable.
        </div>
      </div>
      <a id="backBtn" href="/allocations/" class="btn btn-outline-secondary">← Back to Units</a>
    </div>

    <div id="content"></div>

    <div id="noData" class="alert alert-warning d-none mt-3">
      No allocation data found. Please upload “Tutorial Allocations.xlsx” on the home page first and click a unit again.
    </div>

    <div class="actions pt-3 mt-2 d-flex justify-content-center gap-2">
      <button id="btnEdit" class="btn btn-danger px-5">EDIT</button>
      <button id="btnSubmit" class="btn btn-primary px-5 d-none">SUBMIT</button>
    </div>
  </div>

  <script>
    /* ---------- Auth / API ---------- */
    const API_BASE = "/api";
    const token = () => localStorage.getItem("access");
    const authHeaders = (extra = {}) => token() ? ({ ...extra, Authorization: `Bearer ${token()}` }) : extra;

    async function apiGet(path) {
      const res = await fetch(`${API_BASE}${path}`, { headers: authHeaders(), credentials: "include" });
      const raw = await res.text();
      let data = null; try { data = JSON.parse(raw); } catch { }
      if (res.status === 401) { location.href = "/"; throw new Error("Unauthorized"); }
      if (!res.ok) throw new Error((data && (data.detail || data.message)) || raw || `GET ${path} -> ${res.status}`);
      return data ?? raw;
    }
    async function apiPost(path, body) {
      const res = await fetch(`${API_BASE}${path}`, {
        method: "POST",
        headers: authHeaders({ "Content-Type": "application/json" }),
        body: JSON.stringify(body)
      });
      const raw = await res.text();
      let data = null; try { data = JSON.parse(raw); } catch { }
      if (res.status === 401) { location.href = "/"; throw new Error("Unauthorized"); }
      if (!res.ok) throw new Error((data && (data.detail || data.message)) || raw || `POST ${path} -> ${res.status}`);
      return data ?? raw;
    }

    /* ---------- Query params ---------- */
    const qs = new URLSearchParams(location.search);
    const alias = qs.get("alias") || "";
    const code = (qs.get("code") || "").toUpperCase();
    const campus = qs.get("campus") || "";
    const unitName = qs.get("name") || ""; // URLSearchParams already decodes

    document.addEventListener("DOMContentLoaded", () => {
      if (!token()) { location.href = "/"; return; }
      document.getElementById("backBtn").href = `/allocations/?alias=${encodeURIComponent(alias)}`;
      document.getElementById("title").textContent =
        (code && unitName) ? `${code} – ${unitName}` : (code || unitName || "Unit");
    });

    /* ---------- Page init ---------- */
    document.addEventListener("DOMContentLoaded", init);

    async function init() {
      try {
        if (!token()) return;
        const sessions = await apiGet(`/allocation/sessions/?unit_code=${encodeURIComponent(code)}&campus=${encodeURIComponent(campus)}&alias=${encodeURIComponent(alias)}`);
        if (!Array.isArray(sessions) || !sessions.length) {
          document.getElementById("noData").classList.remove("d-none");
          return;
        }
        renderSessions(sessions);
        wireEditing();
      } catch (e) {
        console.error(e);
        alert("Failed to load sessions: " + (e.message || e));
      }
    }

    /* ---------- Render ---------- */
    function renderSessions(sessions) {
      const wrap = document.createElement("div");
      wrap.className = "table-responsive";
      const table = document.createElement("table");
      table.className = "table table-bordered align-middle";
      table.innerHTML = `
        <thead>
          <tr>
            <th>Activity</th><th>Day</th><th>Start</th><th>Weeks</th><th>Duration</th><th>Location</th>
            <th>Tutors</th><th>Notes</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector("tbody");

      sessions.forEach(s => {
        const tr = document.createElement("tr");
        tr.dataset.sessionId = s.session_id ?? s.id;

        // clickable display name if we have an email
        const tutorDisplay = (() => {
          const name = (s.tutor || "").trim();
          const email = (s.tutor_email || "").trim();
          if (!name) return "";
          if (!email) return name;
          const ttUrl = `/tutors/timetable/?alias=${encodeURIComponent(alias)}&name=${encodeURIComponent(name)}&email=${encodeURIComponent(email)}`;
          return `<a class="staff-chip" href="${ttUrl}" title="View timetable">${name}</a>`;
        })();

        tr.innerHTML = `
          <td>${s.activity_code || ""}</td>
          <td>${s.day_of_week || ""}</td>
          <td>${s.start_time || ""}</td>
          <td>${s.weeks || ""}</td>
          <td>${s.duration || ""}</td>
          <td>${s.location || ""}</td>
          <td>
            <select class="form-select form-select-sm staff-select d-none"
                    data-user-id="${s.tutor_user_id || ""}"
                    data-email="${s.tutor_email || ""}" disabled></select>
            <div class="staff-display">${tutorDisplay}</div>
          </td>
          <td><input type="text" class="form-control form-control-sm notes-input" value="${s.notes || ""}" disabled></td>
        `;
        tbody.appendChild(tr);
      });

      wrap.appendChild(table);
      document.getElementById("content").appendChild(wrap);
    }

    /* ---------- Tutor suggestions (sorted by preference asc; null last) ---------- */
    const tutorCache = new Map(); // key: `${alias}:${code}:${campus}`

    function sortByPrefThenName(list) {
      return list.slice().sort((a, b) => {
        const ap = (a.preference == null) ? Number.POSITIVE_INFINITY : a.preference;
        const bp = (b.preference == null) ? Number.POSITIVE_INFINITY : b.preference;
        return ap !== bp ? ap - bp : (a.name || "").localeCompare(b.name || "");
      });
    }

    async function fetchTutors() {
      const key = `${alias}:${code}:${campus}`;
      if (tutorCache.has(key)) return tutorCache.get(key);
      const data = await apiGet(`/allocation/suggest_tutors/?alias=${encodeURIComponent(alias)}&unit_code=${encodeURIComponent(code)}&campus=${encodeURIComponent(campus)}`);
      const sorted = sortByPrefThenName(data || []);
      tutorCache.set(key, sorted);
      return sorted;
    }

    function populateTutorSelect(selectEl, tutors) {
      const opts = [`<option value="">— Unassigned —</option>`];
      for (const t of tutors) {
        const pref = (t.preference == null) ? "" : ` — pref ${t.preference}`;
        opts.push(`<option value="${t.id}" data-email="${t.email}" data-pref="${t.preference ?? ''}">${t.name} (${t.email})${pref}</option>`);
      }
      selectEl.innerHTML = opts.join("");

      // Preselect current
      const currentId = (selectEl.dataset.userId || "").toString();
      const currentEmail = (selectEl.dataset.email || "").toLowerCase();
      if (currentId) {
        selectEl.value = currentId;
      } else if (currentEmail) {
        const match = Array.from(selectEl.options).find(o => (o.dataset.email || "").toLowerCase() === currentEmail);
        if (match) selectEl.value = match.value;
      }
    }

    /* ---------- Editing ---------- */
    const btnEdit = document.getElementById("btnEdit");
    const btnSubmit = document.getElementById("btnSubmit");

    function wireEditing() {
      btnEdit.addEventListener("click", async () => {
        document.querySelectorAll(".notes-input").forEach(i => i.disabled = false);
        const selects = document.querySelectorAll(".staff-select");
        document.querySelectorAll(".staff-display").forEach(d => d.classList.add("d-none"));
        selects.forEach(s => { s.classList.remove("d-none"); s.disabled = false; });

        try {
          const tutors = await fetchTutors();
          selects.forEach(sel => populateTutorSelect(sel, tutors));
        } catch (e) {
          console.error(e);
          alert("Failed to load tutor suggestions: " + (e.message || e));
        }

        btnSubmit.classList.remove("d-none");
      });

      btnSubmit.addEventListener("click", async () => {
        btnSubmit.disabled = true;

        const rows = [...document.querySelectorAll("tr[data-session-id]")];
        let saved = 0, failed = 0, firstClash = null;

        for (const tr of rows) {
          const id = Number(tr.dataset.sessionId);
          const sel = tr.querySelector(".staff-select");
          const notes = tr.querySelector(".notes-input");

          const originalId = (sel.dataset.userId || "").toString();
          const pickedId = (sel.value || "").toString();
          const originalNote = notes.getAttribute("value") || "";
          const newNote = notes.value || "";

          const changed = (pickedId !== originalId) || (newNote !== originalNote);
          if (!changed) continue;

          const body = { session_id: id, notes: newNote, tutor_id: pickedId ? Number(pickedId) : null };

          try {
            await apiPost(`/allocation/assign/?alias=${encodeURIComponent(alias)}`, body);
            saved++;
          } catch (e) {
            failed++;
            const msg = String(e.message || "");
            if (/clash|conflict/i.test(msg) && !firstClash) {
              const tds = tr.querySelectorAll("td");
              firstClash = { activity: (tds[0]?.textContent || "").trim(), day: (tds[1]?.textContent || "").trim(), start: (tds[2]?.textContent || "").trim(), msg };
            }
          }
        }

        if (firstClash) {
          alert(`Clash detected for:\n${firstClash.activity} — ${firstClash.day} ${firstClash.start}\n\n${firstClash.msg}\n\nOther valid rows were saved.`);
        } else {
          alert(saved ? `Saved ${saved} row(s).` : `No changes to save.`);
        }

        // Reload to reflect current state
        location.href = `/allocationdetails/?alias=${encodeURIComponent(alias)}&code=${encodeURIComponent(code)}&campus=${encodeURIComponent(campus)}&name=${encodeURIComponent(unitName)}`;
      });
    }
  </script>
</body>

</html>