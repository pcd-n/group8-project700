<!-- unit details page -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unit Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .section-title {
      font-weight: 600;
    }

    .pref-select {
      width: 90px;
    }

    .actions {
      border-top: 1px solid #e5e7eb;
    }
  </style>
</head>

<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 id="unitTitle" class="h5 m-0">Unit</h1>
      <a href="/home/" class="btn btn-outline-secondary">← Back to Units</a>
    </div>

    <div id="hobartBlock" class="mb-4 d-none">
      <div class="section-title mb-2">Location: Hobart</div>
      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead class="table-light" id="hobartHead"></thead>
          <tbody id="hobartBody"></tbody>
        </table>
      </div>
    </div>

    <div id="launcBlock" class="mb-4 d-none">
      <div class="section-title mb-2">Location: Launceston</div>
      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead class="table-light" id="launcHead"></thead>
          <tbody id="launcBody"></tbody>
        </table>
      </div>
    </div>

    <div id="otherBlock" class="mb-4 d-none">
      <div class="section-title mb-2">Location: Other</div>
      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead class="table-light" id="otherHead"></thead>
          <tbody id="otherBody"></tbody>
        </table>
      </div>
    </div>

    <div id="noData" class="alert alert-warning d-none">
      No spreadsheet found. Please upload on
      <a href="/home/" class="alert-link">home page</a> first.
    </div>

    <!-- Actions -->
    <div class="actions pt-3 d-flex justify-content-center gap-2">
      <button id="btnEdit" class="btn btn-danger px-5">EDIT</button>
      <button id="btnSubmit" class="btn btn-primary px-5 d-none">
        SUBMIT
      </button>
    </div>
  </div>

  <script>
    /* ---------------- Auth / API helpers ---------------- */
    const API = {
      eoiApplicants: "/api/eoi/applicants/",
      savePrefs: "/api/eoi/preferences/",
    };

    function getAccessToken() { return localStorage.getItem("access"); }
    function authHeaders(extra = {}) {
      const h = { ...extra };
      const t = getAccessToken();
      if (t) h.Authorization = `Bearer ${t}`;
      return h;
    }
    async function apiGet(path) {
      const res = await fetch(path, { headers: authHeaders() });
      if (res.status === 401) { location.href = "/"; throw new Error("Unauthorized"); }
      if (!res.ok) throw new Error(`${res.status} ${await res.text()}`);
      return res.json();
    }
    async function apiPostJSON(path, body) {
      const res = await fetch(path, {
        method: "POST",
        headers: authHeaders({ "Content-Type": "application/json" }),
        body: JSON.stringify(body),
      });
      if (res.status === 401) { location.href = "/"; throw new Error("Unauthorized"); }
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.detail || err.error || `Error ${res.status}`);
      }
      return res.json().catch(() => ({}));
    }

    // --- Query params (single source of truth used by page & details tab) ---
    const QP = new URLSearchParams(location.search);
    const UNIT_CODE = decodeURIComponent(QP.get("code") || "");
    const UNIT_NAME_DISPLAY = decodeURIComponent(QP.get("name") || "");
    const UNIT_TITLE = UNIT_NAME_DISPLAY
      ? `${UNIT_CODE} – ${UNIT_NAME_DISPLAY}`
      : (UNIT_CODE || "Unit");

    document.getElementById("unitTitle").textContent = UNIT_TITLE;

    // --- Storage keys ---
    const PREF_KEY = "eoi_prefs"; // { "<unitCode>|<email>": "3", ... }

    // Page elements
    const hobartBlock = document.getElementById("hobartBlock");
    const launcBlock = document.getElementById("launcBlock");
    const otherBlock = document.getElementById("otherBlock");
    const hobartHead = document.getElementById("hobartHead");
    const hobartBody = document.getElementById("hobartBody");
    const launcHead = document.getElementById("launcHead");
    const launcBody = document.getElementById("launcBody");
    const otherHead = document.getElementById("otherHead");
    const otherBody = document.getElementById("otherBody");
    const btnEdit = document.getElementById("btnEdit");
    const btnSubmit = document.getElementById("btnSubmit");

    let isEditing = false;
    const EOI_BY_EMAIL = new Map();

    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(location.search);
      const unitCode = params.get("code") || "";
      const unitName = decodeURIComponent(params.get("name") || unitCode);
      const titleEl = document.getElementById("unitTitle");
      if (titleEl) {
        if (unitCode && unitName) {
          titleEl.textContent = `${unitCode} – ${unitName}`;
        } else {
          titleEl.textContent = unitCode || unitName || "Unit";
        }
      }
      const alertBox = document.getElementById("noData");

      if (!unitCode) { alertBox.classList.remove("d-none"); return; }

      try {
        // Fetch applicants directly (no /semesters/current/ call)
        const data = await apiGet(`${API.eoiApplicants}?unit_code=${encodeURIComponent(unitCode)}`);
        const list = Array.isArray(data?.results) ? data.results : (Array.isArray(data) ? data : []);

        const apiUnitId =
          (list[0] && (list[0].unit || list[0].unit_id)) ? (list[0].unit || list[0].unit_id) : null;

        const applicants = list.map(a => {
          const name =
            a.applicant_name ||
            [a.first_name, a.last_name].filter(Boolean).join(" ") ||
            a.tutor_name || "";
          const email = a.tutor_email || a.applicant_email || a.email || "";
          const you_are = a.tutor_current || a.status || "";
          const location = a.location_text || a.campus_name || (a.campus?.campus_name || a.campus || "");
          if (email) EOI_BY_EMAIL.set(email.toLowerCase(), a);

          return { name, email, you_are, location, preference: a.preference ?? "", _raw: a };
        });

        if (!applicants.length) {
          alertBox.textContent = "No applicants yet for this unit.";
          alertBox.classList.remove("d-none");
          return;
        }

        renderFromAPI(applicants, unitCode);
        hookEditSubmit({ unitId: apiUnitId, codeForKey: unitCode });

        alertBox.classList.add("d-none");
      } catch (e) {
        console.error(e);
        alertBox.textContent = "Failed to load applicants. Please try again.";
        alertBox.classList.remove("d-none");
      }
    });


    function renderFromAPI(applicants, codeForKey) {
      const headerRow = ["Name", "Email", "Current Status", "Tutoring Location"];
      const prefs = JSON.parse(localStorage.getItem(PREF_KEY) || "{}");
      const groups = { Hobart: [], Launceston: [], Other: [] };

      applicants.forEach((a) => {
        const loc = String(a.location || "").trim().toLowerCase();
        const item = { name: a.name || "", email: a.email || "", you_are: a.you_are || "", location: a.location || "", preference: a.preference || "", _raw: a._raw };
        if (loc === "hobart") groups.Hobart.push(item);
        else if (loc === "launceston") groups.Launceston.push(item);
        else groups.Other.push(item);
      });

      buildSection(hobartHead, hobartBody, groups.Hobart);
      buildSection(launcHead, launcBody, groups.Launceston);
      buildSection(otherHead, otherBody, groups.Other);

      if (groups.Hobart.length) hobartBlock.classList.remove("d-none");
      if (groups.Launceston.length) launcBlock.classList.remove("d-none");
      if (groups.Other.length) otherBlock.classList.remove("d-none");

      function buildSection(headEl, bodyEl, rows) {
        if (!rows.length) return;
        headEl.textContent = "";
        bodyEl.textContent = "";

        const trh = document.createElement("tr");
        const thPref = document.createElement("th"); thPref.textContent = "Preference";
        trh.appendChild(thPref);
        headerRow.forEach((h) => { const th = document.createElement("th"); th.textContent = h; trh.appendChild(th); });
        const thDetails = document.createElement("th"); thDetails.textContent = "Details";
        trh.appendChild(thDetails);
        headEl.appendChild(trh);

        rows.forEach((r) => {
          const tr = document.createElement("tr");

          const tdPref = document.createElement("td");
          const sel = document.createElement("select");
          sel.className = "form-select form-select-sm pref-select";
          sel.disabled = true;

          const key = `${codeForKey || ""}|${(r.email || "").toString().trim()}`;
          const optBlank = document.createElement("option"); optBlank.value = ""; optBlank.textContent = "—";
          sel.appendChild(optBlank);
          for (let i = 1; i <= 10; i++) {
            const o = document.createElement("option"); o.value = String(i); o.textContent = String(i); sel.appendChild(o);
          }

          const fromServer = r.preference ? String(r.preference) : "";
          const fromLocal = prefs[key] ? String(prefs[key]) : "";
          sel.value = fromServer || fromLocal || "";
          sel.dataset.prefKey = key;

          tdPref.appendChild(sel);
          tr.appendChild(tdPref);

          [r.name, r.email, r.you_are, r.location].forEach((val) => {
            const td = document.createElement("td");
            td.textContent = (val ?? "").toString();
            tr.appendChild(td);
          });

          const tdDetails = document.createElement("td");
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "btn btn-sm btn-outline-primary";
          btn.textContent = "View details";
          btn.addEventListener("click", () => {
            const raw = (r.email && EOI_BY_EMAIL.get((r.email || "").toLowerCase())) || r._raw || null;
            openDetailsWindow(raw);
          });
          tdDetails.appendChild(btn);
          tr.appendChild(tdDetails);

          bodyEl.appendChild(tr);
        });
      }
    }

    function hookEditSubmit({ unitId = null, codeForKey = "" }) {
      btnEdit.addEventListener("click", () => {
        isEditing = true;
        btnEdit.classList.add("btn-secondary");
        btnSubmit.classList.remove("d-none");
        document.querySelectorAll(".pref-select").forEach((s) => (s.disabled = false));
      });

      btnSubmit.addEventListener("click", async () => {
        if (!isEditing) return;

        const prefsNow = JSON.parse(localStorage.getItem(PREF_KEY) || "{}");
        const bulk = [];
        document.querySelectorAll(".pref-select").forEach((sel) => {
          const key = sel.dataset.prefKey;
          const val = sel.value.trim();
          if (!key) return;
          const email = key.split("|")[1] || "";
          if (val) {
            prefsNow[key] = val;
            if (email) bulk.push({ email, preference: parseInt(val, 10) });
          } else {
            delete prefsNow[key];
          }
        });

        try {
          const canPost = Boolean(unitId && getAccessToken());
          if (canPost && bulk.length) {
            await apiPostJSON(API.savePrefs, { unit_id: parseInt(unitId, 10), prefs: bulk });
            localStorage.setItem(PREF_KEY, JSON.stringify(prefsNow));
            alert("Preferences saved to server.");
          } else {
            localStorage.setItem(PREF_KEY, JSON.stringify(prefsNow));
            alert("Preferences saved locally.");
          }
        } catch (e) {
          alert(e.message || "Failed to save preferences.");
          return;
        }

        isEditing = false;
        btnSubmit.classList.add("d-none");
        btnEdit.classList.remove("btn-secondary");
        document.querySelectorAll(".pref-select").forEach((s) => (s.disabled = true));
      });
    }

    function openDetailsWindow(o) {
      if (!o) { alert("No details available."); return; }

      // Build "Applied unit" from the page header (code – name), fallback to API fields.
      const appliedUnit = UNIT_CODE
        ? `${UNIT_CODE}${UNIT_NAME_DISPLAY ? " — " + UNIT_NAME_DISPLAY : ""}`
        : (o.unit_code || "");

      const esc = (x) => (x == null ? "" : String(x)).replace(/[&<>"']/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[s]));
      const fmtBool = (v) => (v === true ? "Yes" : v === false ? "No" : "");
      const asList = (v) => Array.isArray(v) ? v.join(", ") : (v ?? "");

      const coreLines = [
        `<strong>Name:</strong> ${esc(o.applicant_name || o.tutor_name || "")}`,
        `<strong>Email:</strong> ${esc(o.applicant_email || o.tutor_email || o.email || "")}`,
        `<strong>Applied unit:</strong> ${esc(appliedUnit)}`,
        `<strong>Status:</strong> ${esc(o.status || "")}`,
        (o.preference ? `<strong>Preference:</strong> ${esc(o.preference)}` : "")
      ].filter(Boolean);

      const extra = [
        ["Campus", o.campus_name || o.location_text],
        ["You are", o.tutor_current],
        ["GPA", o.gpa],
        ["Supervisor / Reference", o.supervisor],
        ["Applied units (all)", asList(o.applied_units)],
        ["Qualifications", o.qualifications],
        ["Tutoring experience", o.tutoring_experience],
        ["Availability", o.availability],
        ["Hours available", o.hours_available],
        ["Scholarship received", fmtBool(o.scholarship_received)],
        ["Transcript link", o.transcript_link],
        ["CV link", o.cv_link],
        ["Remarks", o.remarks],
        ["Created at", o.created_at],
        ["Updated at", o.updated_at],
      ];

      const rows = extra
        .filter(([_, v]) => v !== null && v !== undefined && String(v).trim() !== "")
        .map(([k, v]) => {
          const val = (k.toLowerCase().includes("link") && v)
            ? `<a href="${esc(v)}" target="_blank" rel="noopener">${esc(v)}</a>`
            : esc(v);
          return `<tr><th style="white-space:nowrap;width:220px">${esc(k)}</th><td>${val}</td></tr>`;
        })
        .join("");

      const html = `
        <!doctype html>
        <html>
          <head>
            <meta charset="utf-8" />
            <title>EOI Details</title>
            <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
          </head>
          <body class="p-3">
            <div class="container">
              <h2 class="h5 mb-3">EOI Details</h2>
              <div class="mb-3">
                ${coreLines.map(line => `<div>${line}</div>`).join("")}
              </div>
              <div class="table-responsive">
                <table class="table table-sm table-bordered align-middle">
                  <tbody>
                    ${rows || `<tr><td colspan="2" class="text-muted">No additional information.</td></tr>`}
                  </tbody>
                </table>
              </div>
            </div>
          </body>
        </html>
      `;

      // Open in a real new tab using a Blob URL
      const blob = new Blob([html], { type: "text/html" });
      const url = URL.createObjectURL(blob);
      window.open(url, "_blank");
    }

  </script>


</body>

</html>