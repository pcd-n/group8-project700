<!-- unit details page -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unit Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .section-title {
      font-weight: 600;
    }

    .pref-select {
      width: 90px;
    }

    .actions {
      border-top: 1px solid #e5e7eb;
    }
  </style>
</head>

<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 id="unitTitle" class="h5 m-0">Unit</h1>
      <a href="home.html" class="btn btn-outline-secondary">← Back to Units</a>
    </div>

    <div id="hobartBlock" class="mb-4 d-none">
      <div class="section-title mb-2">Location: Hobart</div>
      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead class="table-light" id="hobartHead"></thead>
          <tbody id="hobartBody"></tbody>
        </table>
      </div>
    </div>

    <div id="launcBlock" class="mb-4 d-none">
      <div class="section-title mb-2">Location: Launceston</div>
      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead class="table-light" id="launcHead"></thead>
          <tbody id="launcBody"></tbody>
        </table>
      </div>
    </div>

    <div id="otherBlock" class="mb-4 d-none">
      <div class="section-title mb-2">Location: Other</div>
      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead class="table-light" id="otherHead"></thead>
          <tbody id="otherBody"></tbody>
        </table>
      </div>
    </div>

    <div id="noData" class="alert alert-warning d-none">
      No spreadsheet found. Please upload on
      <a href="home.html" class="alert-link">home page</a> first.
    </div>

    <!-- Actions -->
    <div class="actions pt-3 d-flex justify-content-center gap-2">
      <button id="btnEdit" class="btn btn-danger px-5">EDIT</button>
      <button id="btnSubmit" class="btn btn-primary px-5 d-none">
        SUBMIT
      </button>
    </div>
  </div>

  <script>
    /* ---------------- Auth / API helpers ---------------- */
    const API = {
      eoiApplicants: "/api/eoi/applicants/",
      savePrefs: "/api/eoi/preferences/",
      semestersCurrent: "/api/semesters/current/",
      semestersList: "/api/semesters/",
    };

    function getAccessToken() { return localStorage.getItem("access"); }
    function authHeaders(extra = {}) {
      const h = { ...extra };
      const t = getAccessToken();
      if (t) h.Authorization = `Bearer ${t}`;
      return h;
    }
    async function apiGet(path) {
      const res = await fetch(path, { headers: authHeaders() });
      if (res.status === 401) { location.href = "/"; throw new Error("Unauthorized"); }
      if (!res.ok) throw new Error(`${res.status} ${await res.text()}`);
      return res.json();
    }
    async function getCurrentAlias() {
      try {
        const { alias } = await apiGet(API.semestersCurrent);
        return alias;
      } catch {
        const list = await apiGet(API.semestersList);
        const cur = (list || []).find(s => s.is_current) || (list || [])[0];
        if (!cur) throw new Error("No semesters available");
        return cur.alias;
      }
    }
    async function apiPostJSON(path, body) {
      const res = await fetch(path, {
        method: "POST",
        headers: authHeaders({ "Content-Type": "application/json" }),
        body: JSON.stringify(body),
      });
      if (res.status === 401) { location.href = "/"; throw new Error("Unauthorized"); }
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.detail || err.error || `Error ${res.status}`);
      }
      return res.json().catch(() => ({}));
    }

    // --- Query params ---
    const params = new URLSearchParams(location.search);
    const sheetName = params.get("sheet") || "";
    const unitTitleStr = decodeURIComponent(params.get("title") || "");
    const unitCode = decodeURIComponent(params.get("code") || "");
    const unitId = params.get("id") || "";     // <-- used for backend calls

    document.getElementById("unitTitle").textContent = unitTitleStr || sheetName || "Unit";

    // --- Storage keys ---
    const SHEETS_KEY = "eoi_sheets_aoa";
    const PREF_KEY = "eoi_prefs"; // { "<unitCode>|<email>": "3", ... }

    // Page elements
    const hobartBlock = document.getElementById("hobartBlock");
    const launcBlock = document.getElementById("launcBlock");
    const otherBlock = document.getElementById("otherBlock");
    const hobartHead = document.getElementById("hobartHead");
    const hobartBody = document.getElementById("hobartBody");
    const launcHead = document.getElementById("launcHead");
    const launcBody = document.getElementById("launcBody");
    const otherHead = document.getElementById("otherHead");
    const otherBody = document.getElementById("otherBody");
    const btnEdit = document.getElementById("btnEdit");
    const btnSubmit = document.getElementById("btnSubmit");

    let isEditing = false;

    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(location.search);
      const unitCode = params.get("code") || "";
      const unitName = decodeURIComponent(params.get("name") || unitCode);
      const titleEl = document.getElementById("unitTitle");
      if (titleEl) titleEl.textContent = unitName || unitCode;

      const alertBox = document.getElementById("noData");

      if (!unitCode) { alertBox.classList.remove("d-none"); return; }

      try {
        await getCurrentAlias(); // avoid /semesters/current/ 404

        // Fetch applicants for this unit
        const data = await apiGet(`${API.eoiApplicants}?unit_code=${encodeURIComponent(unitCode)}`);
        const list = Array.isArray(data?.results) ? data.results : (Array.isArray(data) ? data : []);

        // NEW: get the unit id for saving preferences
        const apiUnitId =
          (list[0] && (list[0].unit || list[0].unit_id)) ? (list[0].unit || list[0].unit_id) : null;

        // NEW: keep server-side preference in each item
        const applicants = list.map(a => ({
          name: a.applicant_name || [a.first_name, a.last_name].filter(Boolean).join(" ") || a.tutor_name || "",
          email: a.tutor_email || a.applicant_email || a.email || "",
          you_are: a.tutor_current || a.status || "",
          location: a.location_text || a.campus_name || (a.campus?.campus_name || a.campus || ""),
          preference: a.preference ?? ""   // <-- keep server preference
        }));

        if (!applicants.length) {
          alertBox.textContent = "No applicants yet for this unit.";
          alertBox.classList.remove("d-none");
          return;
        }

        renderFromAPI(applicants, unitCode);
        hookEditSubmit({ mode: "api", unitId: apiUnitId, codeForKey: unitCode });

        alertBox.classList.add("d-none");
      } catch (e) {
        console.error(e);
        alertBox.textContent = "Failed to load applicants. Please try again.";
        alertBox.classList.remove("d-none");
      }
    });


    // --- API rendering (same visual structure) ---
    function renderFromAPI(applicants, codeForKey) {
      const headerRow = ["Name", "Email", "Current Status", "Tutoring Location"];
      const prefs = JSON.parse(localStorage.getItem(PREF_KEY) || "{}");
      const groups = { Hobart: [], Launceston: [], Other: [] };

      applicants.forEach((a) => {
        const loc = String(a.location || "").trim().toLowerCase();
        const item = { name: a.name || "", email: a.email || "", you_are: a.you_are || "", location: a.location || "", preference: a.preference || "" };
        if (loc === "hobart") groups.Hobart.push(item);
        else if (loc === "launceston") groups.Launceston.push(item);
        else groups.Other.push(item);
      });

      buildSection(hobartHead, hobartBody, groups.Hobart);
      buildSection(launcHead, launcBody, groups.Launceston);
      buildSection(otherHead, otherBody, groups.Other);

      if (groups.Hobart.length) hobartBlock.classList.remove("d-none");
      if (groups.Launceston.length) launcBlock.classList.remove("d-none");
      if (groups.Other.length) otherBlock.classList.remove("d-none");

      function buildSection(headEl, bodyEl, rows) {
        if (!rows.length) return;

        const trh = document.createElement("tr");
        const thPref = document.createElement("th"); thPref.textContent = "Preference";
        trh.appendChild(thPref);
        headerRow.forEach((h) => { const th = document.createElement("th"); th.textContent = h; trh.appendChild(th); });
        headEl.appendChild(trh);

        rows.forEach((r) => {
          const tr = document.createElement("tr");

          const tdPref = document.createElement("td");
          const sel = document.createElement("select");
          sel.className = "form-select form-select-sm pref-select";
          sel.disabled = true;

          const key = `${codeForKey || ""}|${(r.email || "").toString().trim()}`;
          const optBlank = document.createElement("option"); optBlank.value = ""; optBlank.textContent = "—";
          sel.appendChild(optBlank);
          for (let i = 1; i <= 10; i++) {
            const o = document.createElement("option"); o.value = String(i); o.textContent = String(i); sel.appendChild(o);
          }

          // NEW: prefer server's preference, fallback to local cache
          const fromServer = r.preference ? String(r.preference) : "";
          const fromLocal = prefs[key] ? String(prefs[key]) : "";
          sel.value = fromServer || fromLocal || "";
          sel.dataset.prefKey = key;

          tdPref.appendChild(sel);
          tr.appendChild(tdPref);

          // Cells in order: Name, Email, You are, Tutoring Location
          [r.name, r.email, r.you_are, r.location].forEach((val) => {
            const td = document.createElement("td");
            td.textContent = (val ?? "").toString();
            tr.appendChild(td);
          });

          bodyEl.appendChild(tr);
        });
      }
    }

    // --- Edit / Submit logic ---
    function hookEditSubmit({ mode, unitId = null, codeForKey = "" }) {
      btnEdit.addEventListener("click", () => {
        isEditing = true;
        btnEdit.classList.add("btn-secondary");
        btnSubmit.classList.remove("d-none");
        document.querySelectorAll(".pref-select").forEach((s) => (s.disabled = false));
      });

      btnSubmit.addEventListener("click", async () => {
        if (!isEditing) return;

        const prefsNow = JSON.parse(localStorage.getItem(PREF_KEY) || "{}");
        const bulk = [];
        document.querySelectorAll(".pref-select").forEach((sel) => {
          const key = sel.dataset.prefKey; // "<unitCode>|<email>"
          const val = sel.value.trim();
          if (!key) return;
          const email = key.split("|")[1] || "";
          if (val) {
            prefsNow[key] = val;
            if (email) bulk.push({ email, preference: parseInt(val, 10) });
          } else {
            delete prefsNow[key];
          }
        });

        try {
          const canPost = Boolean(unitId && getAccessToken());   // <= unitId was set from API
          if (canPost && bulk.length) {
            await apiPostJSON(API.savePrefs, { unit_id: parseInt(unitId, 10), prefs: bulk });
            localStorage.setItem(PREF_KEY, JSON.stringify(prefsNow)); // keep local cache in sync
            alert("Preferences saved to server.");
          } else {
            localStorage.setItem(PREF_KEY, JSON.stringify(prefsNow));
            alert("Preferences saved locally.");
          }
        } catch (e) {
          alert(e.message || "Failed to save preferences.");
          return;
        }

        isEditing = false;
        btnSubmit.classList.add("d-none");
        btnEdit.classList.remove("btn-secondary");
        document.querySelectorAll(".pref-select").forEach((s) => (s.disabled = true));
      });
    }
  </script>

</body>

</html>