<!-- unit details page -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Unit Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    .section-title {
      font-weight: 600;
    }

    .pref-select {
      width: 90px;
    }

    .actions {
      border-top: 1px solid #e5e7eb;
    }
  </style>
</head>

<body>
  <div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h1 id="unitTitle" class="h5 m-0">Unit</h1>
      <a href="home.html" class="btn btn-outline-secondary">← Back to Units</a>
    </div>

    <div id="hobartBlock" class="mb-4 d-none">
      <div class="section-title mb-2">Location: Hobart</div>
      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead class="table-light" id="hobartHead"></thead>
          <tbody id="hobartBody"></tbody>
        </table>
      </div>
    </div>

    <div id="launcBlock" class="mb-4 d-none">
      <div class="section-title mb-2">Location: Launceston</div>
      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead class="table-light" id="launcHead"></thead>
          <tbody id="launcBody"></tbody>
        </table>
      </div>
    </div>

    <div id="otherBlock" class="mb-4 d-none">
      <div class="section-title mb-2">Location: Other</div>
      <div class="table-responsive">
        <table class="table table-bordered align-middle">
          <thead class="table-light" id="otherHead"></thead>
          <tbody id="otherBody"></tbody>
        </table>
      </div>
    </div>

    <div id="noData" class="alert alert-warning d-none">
      No spreadsheet found. Please upload on
      <a href="home.html" class="alert-link">home page</a> first.
    </div>

    <!-- Actions -->
    <div class="actions pt-3 d-flex justify-content-center gap-2">
      <button id="btnEdit" class="btn btn-danger px-5">EDIT</button>
      <button id="btnSubmit" class="btn btn-primary px-5 d-none">
        SUBMIT
      </button>
    </div>
  </div>

  <script>
    /* ---------------- Auth / API helpers ---------------- */
    const API = {
      base: "/api",
      unit: (id) => `/units/${id}/`,
      applicants: (unitId) => `/eoi/applicants/?unit_id=${encodeURIComponent(unitId)}`,
      savePrefs: "/eoi/preferences/",
    };

    function getAccessToken() { return localStorage.getItem("access"); }
    function authHeaders(extra = {}) {
      const t = getAccessToken();
      return t ? { ...extra, Authorization: `Bearer ${t}` } : extra;
    }
    async function apiGet(path) {
      const res = await fetch(`${API.base}${path}`, { headers: authHeaders() });
      if (res.status === 401) { window.location.href = "/"; throw new Error("Unauthorized"); }
      if (!res.ok) throw new Error(`Error ${res.status}`);
      return res.json();
    }
    async function apiPostJSON(path, body) {
      const res = await fetch(`${API.base}${path}`, {
        method: "POST",
        headers: authHeaders({ "Content-Type": "application/json" }),
        body: JSON.stringify(body),
      });
      if (res.status === 401) { window.location.href = "/"; throw new Error("Unauthorized"); }
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.detail || err.error || `Error ${res.status}`);
      }
      return res.json().catch(() => ({}));
    }

    // --- Query params ---
    const params = new URLSearchParams(location.search);
    const sheetName = params.get("sheet") || "";
    const unitTitleStr = decodeURIComponent(params.get("title") || "");
    const unitCode = decodeURIComponent(params.get("code") || "");
    const unitId = params.get("id") || "";     // <-- used for backend calls

    document.getElementById("unitTitle").textContent = unitTitleStr || sheetName || "Unit";

    // --- Storage keys ---
    const SHEETS_KEY = "eoi_sheets_aoa";
    const PREF_KEY = "eoi_prefs"; // { "<unitCode>|<email>": "3", ... }

    // Page elements
    const hobartBlock = document.getElementById("hobartBlock");
    const launcBlock = document.getElementById("launcBlock");
    const otherBlock = document.getElementById("otherBlock");
    const hobartHead = document.getElementById("hobartHead");
    const hobartBody = document.getElementById("hobartBody");
    const launcHead = document.getElementById("launcHead");
    const launcBody = document.getElementById("launcBody");
    const otherHead = document.getElementById("otherHead");
    const otherBody = document.getElementById("otherBody");
    const btnEdit = document.getElementById("btnEdit");
    const btnSubmit = document.getElementById("btnSubmit");

    let isEditing = false;

    document.addEventListener("DOMContentLoaded", init);

    async function init() {
      // ---------- BACKEND MODE ----------
      if (getAccessToken() && unitId) {
        try {
          // 1) Title from backend (optional)
          const unit = await apiGet(API.unit(unitId)).catch(() => ({}));
          const code = unit.unit_code || unit.code || unitCode || "";
          const name = unit.unit_name || unit.name || "";
          if (code || name) {
            document.getElementById("unitTitle").textContent = `${code} ${name}`.trim();
          }

          // 2) Applicants for this unit
          const applicants = (await apiGet(API.applicants(unitId))) || [];
          if (Array.isArray(applicants) && applicants.length) {
            renderFromAPI(applicants, code);
            hookEditSubmit({ mode: "api", unitId, codeForKey: code });
            return;
          }
        } catch {
          // fall back to spreadsheet
        }
      }

      // ---------- SPREADSHEET FALLBACK ----------
      const store = localStorage.getItem(SHEETS_KEY);
      if (!store) { document.getElementById("noData").classList.remove("d-none"); return; }
      const AOA = JSON.parse(store) || {};
      const rows = (AOA && AOA[sheetName]) || [];
      // Detect header row
      const required = ["name", "email", "you are", "tutoring location"];
      let headerIdx = -1;
      for (let r = 0; r < Math.min(rows.length, 250); r++) {
        const lower = rows[r].map((c) => String(c).trim().toLowerCase());
        const ok = required.every((k) => lower.some((x) => x.includes(k)));
        if (ok) { headerIdx = r; break; }
      }
      if (headerIdx === -1) { document.getElementById("noData").classList.remove("d-none"); return; }

      const headerRow = rows[headerIdx];
      const idx = (label) => headerRow.findIndex((h) => String(h).toLowerCase().includes(label));
      const nameCol = idx("name");
      const emailCol = idx("email");
      const locCol = idx("tutoring location");

      const prefs = JSON.parse(localStorage.getItem(PREF_KEY) || "{}");
      const bodyRows = rows.slice(headerIdx + 1).filter((r) => r.some((c) => String(c).trim() !== ""));
      const groups = { Hobart: [], Launceston: [], Other: [] };
      bodyRows.forEach((r) => {
        const loc = (r[locCol] || "").toString().trim().toLowerCase();
        if (loc === "hobart") groups.Hobart.push(r);
        else if (loc === "launceston") groups.Launceston.push(r);
        else groups.Other.push(r);
      });

      buildSection("hobart", hobartHead, hobartBody, groups.Hobart, headerRow, prefs, emailCol);
      buildSection("launc", launcHead, launcBody, groups.Launceston, headerRow, prefs, emailCol);
      buildSection("other", otherHead, otherBody, groups.Other, headerRow, prefs, emailCol);

      if (groups.Hobart.length) hobartBlock.classList.remove("d-none");
      if (groups.Launceston.length) launcBlock.classList.remove("d-none");
      if (groups.Other.length) otherBlock.classList.remove("d-none");

      hookEditSubmit({ mode: "fallback", codeForKey: unitCode });

      // helpers for fallback table
      function buildSection(prefix, headEl, bodyEl, dataRows, headerRow, prefs, emailCol) {
        if (!dataRows.length) return;

        const trh = document.createElement("tr");
        const thPref = document.createElement("th"); thPref.textContent = "Preference";
        trh.appendChild(thPref);
        headerRow.forEach((h) => {
          if (!String(h).trim()) return;
          const th = document.createElement("th"); th.textContent = h; trh.appendChild(th);
        });
        headEl.appendChild(trh);

        dataRows.forEach((r) => {
          const tr = document.createElement("tr");

          // Preference select (disabled until EDIT)
          const tdPref = document.createElement("td");
          const sel = document.createElement("select");
          sel.className = "form-select form-select-sm pref-select";
          sel.disabled = true;
          const key = `${unitCode}|${(r[emailCol] || "").toString().trim()}`;

          const optBlank = document.createElement("option");
          optBlank.value = ""; optBlank.textContent = "—"; sel.appendChild(optBlank);
          for (let i = 1; i <= 10; i++) {
            const o = document.createElement("option");
            o.value = String(i); o.textContent = String(i); sel.appendChild(o);
          }
          const saved = prefs[key]; if (saved) sel.value = saved;
          sel.dataset.prefKey = key;

          tdPref.appendChild(sel);
          tr.appendChild(tdPref);

          // Original columns
          headerRow.forEach((_, c) => {
            const td = document.createElement("td");
            td.textContent = (r[c] ?? "").toString();
            tr.appendChild(td);
          });

          bodyEl.appendChild(tr);
        });
      }
    }

    // --- API rendering (same visual structure) ---
    function renderFromAPI(applicants, codeForKey) {
      const headerRow = ["Name", "Email", "You are", "Tutoring Location"];
      const prefs = JSON.parse(localStorage.getItem(PREF_KEY) || "{}");
      const groups = { Hobart: [], Launceston: [], Other: [] };

      applicants.forEach((a) => {
        const loc = String(a.location || a.tutoring_location || "").trim().toLowerCase();
        const row = [a.name || "", a.email || "", a.you_are || a.role || "", a.location || a.tutoring_location || ""];
        if (loc === "hobart") groups.Hobart.push(row);
        else if (loc === "launceston") groups.Launceston.push(row);
        else groups.Other.push(row);
      });

      buildSectionFromAPI(hobartHead, hobartBody, groups.Hobart);
      buildSectionFromAPI(launcHead, launcBody, groups.Launceston);
      buildSectionFromAPI(otherHead, otherBody, groups.Other);

      if (groups.Hobart.length) hobartBlock.classList.remove("d-none");
      if (groups.Launceston.length) launcBlock.classList.remove("d-none");
      if (groups.Other.length) otherBlock.classList.remove("d-none");

      function buildSectionFromAPI(headEl, bodyEl, dataRows) {
        if (!dataRows.length) return;

        const trh = document.createElement("tr");
        const thPref = document.createElement("th"); thPref.textContent = "Preference";
        trh.appendChild(thPref);
        headerRow.forEach((h) => { const th = document.createElement("th"); th.textContent = h; trh.appendChild(th); });
        headEl.appendChild(trh);

        dataRows.forEach((r) => {
          const tr = document.createElement("tr");

          const tdPref = document.createElement("td");
          const sel = document.createElement("select");
          sel.className = "form-select form-select-sm pref-select";
          sel.disabled = true;
          const key = `${codeForKey || ""}|${(r[1] || "").toString().trim()}`; // r[1] = email
          const optBlank = document.createElement("option");
          optBlank.value = ""; optBlank.textContent = "—"; sel.appendChild(optBlank);
          for (let i = 1; i <= 10; i++) { const o = document.createElement("option"); o.value = String(i); o.textContent = String(i); sel.appendChild(o); }
          const saved = prefs[key]; if (saved) sel.value = saved;
          sel.dataset.prefKey = key;
          tdPref.appendChild(sel);
          tr.appendChild(tdPref);

          headerRow.forEach((_, c) => {
            const td = document.createElement("td");
            td.textContent = (r[c] ?? "").toString();
            tr.appendChild(td);
          });

          bodyEl.appendChild(tr);
        });
      }
    }

    // --- Edit / Submit logic ---
    function hookEditSubmit({ mode, unitId = null, codeForKey = "" }) {
      btnEdit.addEventListener("click", () => {
        isEditing = true;
        btnEdit.classList.add("btn-secondary");
        btnSubmit.classList.remove("d-none");
        document.querySelectorAll(".pref-select").forEach((s) => (s.disabled = false));
      });

      btnSubmit.addEventListener("click", async () => {
        if (!isEditing) return;

        // Collect current selections from the table
        const prefsNow = JSON.parse(localStorage.getItem(PREF_KEY) || "{}");
        const bulk = []; // for backend: [{email, preference}]
        document.querySelectorAll(".pref-select").forEach((sel) => {
          const key = sel.dataset.prefKey; // "<unitCode>|<email>"
          const val = sel.value.trim();
          if (!key) return;
          if (val) {
            prefsNow[key] = val;
            const email = key.split("|")[1] || "";
            if (email) bulk.push({ email, preference: parseInt(val, 10) });
          } else {
            delete prefsNow[key];
          }
        });

        try {
          // If logged in and unitId is known -> save to backend
          if (mode === "api" && unitId && getAccessToken()) {
            await apiPostJSON(API.savePrefs, { unit_id: parseInt(unitId, 10), prefs: bulk });
            // keep local cache in sync (optional)
            localStorage.setItem(PREF_KEY, JSON.stringify(prefsNow));
            alert("Preferences saved to server.");
          } else {
            // fallback: local only
            localStorage.setItem(PREF_KEY, JSON.stringify(prefsNow));
            alert("Preferences saved locally.");
          }
        } catch (e) {
          alert(e.message || "Failed to save preferences.");
          return;
        }

        // lock UI again
        isEditing = false;
        btnSubmit.classList.add("d-none");
        btnEdit.classList.remove("btn-secondary");
        document.querySelectorAll(".pref-select").forEach((s) => (s.disabled = true));
      });
    }
  </script>

</body>

</html>